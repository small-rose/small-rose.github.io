<!-- build time:Fri Aug 21 2020 12:34:57 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="keywords" content="JAVA,jvm,监控调优工具"><meta name="description" content="个人技术笔记，记录学习/开发问题"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>jvm监控调优工具 | 张小菜苔</title><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/css/matery.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/css/my.css"><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/jquery/jquery.min.js"></script><script type="text/javascript">window.$crisp=[],window.CRISP_WEBSITE_ID="0c0bcdb7-097e-402f-bb6b-9cf042148a9e",function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)}()</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="张小菜苔" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><div><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/logo-1.png" class="logo-img" alt="LOGO"> <span class="logo-span diyFont">张小菜苔</span></div></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home"></i><span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags"></i><span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark"></i><span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive"></i><span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle"></i><span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="https://zhangxiaocai.cn/contact" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fas fa-comments"></i><span>留言薄</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book"></i><span>友情链接</span></a></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fas fa-list"></i> <span>Secret</span> <i class="fas fa-chevron-down" aria-hidden="true"></i></a><ul class="sub-nav menus_item_child"><li><a href="/navigate"><i class="fas fa-location-arrow" style="margin-top:-20px"></i> <span>导航</span></a></li><li><a href="/box"><i class="fas fa-map-marker" style="margin-top:-20px"></i> <span>收藏</span></a></li><li><a href="https://hut.zhangxiaocai.cn" target="_blank" rel="noopener"><i class="fas fa-pen-alt" style="margin-top:-20px"></i> <span>写作</span></a></li><li><a href="https://yun.zhangxiaocai.cn" target="_blank" rel="noopener"><i class="fas fa-cloud" style="margin-top:-20px"></i> <span>云盘</span></a></li></ul></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索"></i></a></li><li><a href="javascript:fullscreen()" class="modal-trigger waves-effect waves-light"><i id="fullscreen" class="fa fa-expand-arrows-alt" title="全屏"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/logo-1.png" class="logo-img circle responsive-img"><div class="logo-name">张小菜苔</div><div class="logo-desc">个人技术笔记，记录学习/开发问题</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="https://zhangxiaocai.cn/contact" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言薄</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-list"></i> Secret <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/navigate" style="margin-left:75px"><i class="fa fas fa-location-arrow" style="position:absolute;left:50px"></i> <span>导航</span></a></li><li><a href="/box" style="margin-left:75px"><i class="fa fas fa-map-marker" style="position:absolute;left:50px"></i> <span>收藏</span></a></li><li><a href="https://hut.zhangxiaocai.cn" target="_blank" rel="noopener" style="margin-left:75px"><i class="fa fas fa-pen-alt" style="position:absolute;left:50px"></i> <span>写作</span></a></li><li><a href="https://yun.zhangxiaocai.cn" target="_blank" rel="noopener" style="margin-left:75px"><i class="fa fas fa-cloud" style="position:absolute;left:50px"></i> <span>云盘</span></a></li></ul></li></ul></div></div></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(/images/jvm-logo.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">jvm监控调优工具</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:32px;bottom:155px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/JVM/"><span class="chip bg-color">JVM</span> </a><a href="/tags/%E7%9B%91%E6%8E%A7%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7/"><span class="chip bg-color">监控调优工具</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/JVM/" class="post-category">JVM</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2020-06-09</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 8.3k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp; 31 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="JVM常用工具"><a href="#JVM常用工具" class="headerlink" title="JVM常用工具"></a>JVM常用工具</h2><p>之所以要使用JVM工具当然是为了定位系统问题。常见的可依赖的数据包括但不限于异常堆栈、虚拟机运行日志、垃圾收集日志、线程快照（threadump/javacore文件）、堆转储快照（heapdump/ hprof文件）等。</p><h3 id="一、基础故障处理工具"><a href="#一、基础故障处理工具" class="headerlink" title="一、基础故障处理工具"></a>一、基础故障处理工具</h3><p>主要分三类：</p><p>（a）商业授权工具。</p><blockquote><p>主要是JMC（Java Mission Control）及它要使用到的JFR（Java Flight Recorder）。</p></blockquote><p>（b）正式支持工具.</p><blockquote><p>这一类工具属于被长期支持的工具，不同平台、不同版本的JDK之间，这类工具可能会略有差异，但是不会出现某一个工具突然消失的情况。</p></blockquote><p>（c）实验性工具。</p><blockquote><p>这一类工具在它们的使用说明中被声明为”没有技术支持，并且是实验性质的”（Unsupported and Experimental）产品，日后可能会转正，也可能会在某个JDK版本中无声无息地消失。但事实上它们通常都非常稳定而且功能强大，也能在处理应用程序性能问题、定位故障时发挥很大的作用。</p></blockquote><p>JDK5需要手动开启JMX:”<code>-Dcom.sun.management.jmxremote</code>“开启JMX管理功能。</p><h4 id="1、jps"><a href="#1、jps" class="headerlink" title="1、jps"></a>1、jps</h4><p>jps（JVMProcess Status Tool）是虚拟机进程状况工具。</p><blockquote><p>可以列出正在运行的虚拟机进程，并显示虚拟机执行主类（Main Class，main()函数所在的类）名称以及这些进程的本地虚拟机唯一ID（LVMID，Local Virtual Machine Identifier）。</p><p>可以通过RMI协议查询开启了RMI服务的远程虚拟机进程状态，参数hostid为RMI注册表中注册的主机名。</p></blockquote><p>特点：功能单一，使用频率最高</p><p>命令格式：</p><pre><code>jps [ options ] [ hostid ]</code></pre><p>如：jsp -l</p><p>options主要有4个</p><table><thead><tr><th align="center">选项</th><th>作用</th></tr></thead><tbody><tr><td align="center">-q</td><td>只输出LVMID，省略主类名称</td></tr><tr><td align="center">-m</td><td>输出虚拟机进程启动时传递给主类main() 函数的参数</td></tr><tr><td align="center">-l</td><td>输出主类的全名，如果进程执行的jar包，则输出jar全路径</td></tr><tr><td align="center">-v</td><td>输出虚拟机进程启动时的JVM参数</td></tr></tbody></table><h4 id="2、jstat"><a href="#2、jstat" class="headerlink" title="2、jstat"></a>2、jstat</h4><p>jstat（JVM Statistics Monitoring Tool）是虚拟机统计信息监视工具。</p><blockquote><p>用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程[插图]虚拟机进程中的类加载、内存、垃圾收集、即时编译等运行时数据，在没有GUI图形界面、只提供了纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的常用工具。</p></blockquote><p>jstat命令格式为：</p><pre class="language-bash"><code class="language-bash">jstat <span class="token punctuation">[</span> option vmid <span class="token punctuation">[</span> interval<span class="token punctuation">[</span>s<span class="token operator">|</span>ms<span class="token punctuation">]</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">]</span></code></pre><p>如果是本地虚拟机进程，VMID与LVMID是一致的；如果是远程虚拟机进程，那VMID的格式应当是：</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>protocal:<span class="token punctuation">]</span><span class="token punctuation">[</span>//<span class="token punctuation">]</span>lvmid<span class="token punctuation">[</span>@hostname<span class="token punctuation">[</span>:port<span class="token punctuation">]</span>/servername<span class="token punctuation">]</span></code></pre><p>参数interval和count代表查询间隔和次数，如果省略这2个参数，说明只查询一次。</p><p>假设需要每250毫秒查询一次进程10164垃圾收集状况，一共查询20次，那命令应当是：</p><pre class="language-bash"><code class="language-bash">jstat -gc 10164 250 20</code></pre><p>选项option代表用户希望查询的虚拟机信息，主要分为三类：类加载、垃圾收集、运行期编译状况。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-options-jstat.jpg" alt="jstat主要选项"></p><p>jstat执行样例：</p><pre><code>jstat -gcutil 2764
S0      S1      E       O        P        YGC    YGCT     FGC    FGCT     GCT
0.00    0.00    6.20    41.42    47.20    16     0.105    3      0.472    0.577</code></pre><p>新生代Eden区（E，表示Eden）使用了6.2%的空间，2个Survivor区（S0、S1，表示Survivor0、Survivor1）里面都是空的，老年代（O，表示Old）和永久代（P，表示Permanent）则分别使用了41.42%和47.20%的空间。程序运行以来共发生MinorGC（YGC，表示Young GC）16次，总耗时0.105秒；发生FullGC（FGC，表示Full GC）3次，总耗时（FGCT，表示Full GC Time）为0.472秒；所有GC总耗时（GCT，表示GC Time）为0.577秒。</p><p>如果使用时遇到这样单个字母要认识。</p><h4 id="3、jinfo"><a href="#3、jinfo" class="headerlink" title="3、jinfo"></a>3、jinfo</h4><p>jinfo（Configuration Info for Java）的是Java配置信息工具。</p><p>作用是实时查看和调整虚拟机各项参数。</p><p><code>jps -v</code>可以查看虚拟机启动时显式指定的参数列表。</p><p><code>jinfo -flag</code>可以查看虚拟机未被显式指定的参数的系统默认值。若jdk6以上版本也可以使用<code>-XX：+PrintFlagsFinal</code>查看参数默认值。</p><p><code>jinfo -sysprops</code>可以把虚拟机进程的System.getProperties()的内容打印出来。这个命令在JDK 5时期已经随着Linux版的JDK发布，当时只提供了信息查询的功能，JDK 6之后，jinfo在Windows和Linux平台都有提供，并且加入了在运行期修改部分参数值的能力（可以使用-flag[+|-]name或者-flag name=value在运行期修改一部分运行期可写的虚拟机参数值）。</p><p>在JDK 6中，jinfo对于Windows平台功能仍然有较大限制，只提供了最基本的-flag选项。</p><p>命令格式：</p><pre class="language-bash"><code class="language-bash">jinfo  <span class="token punctuation">[</span> option <span class="token punctuation">]</span> pid</code></pre><p>执行样例：查询CMSInitiatingOccupancyFraction参数值:</p><pre class="language-bash"><code class="language-bash">jinfo -flag CMSInitiatingOccupancyFraction 1444
-XX:CMSInitiatingOccupancyFraction<span class="token operator">=</span>85</code></pre><h4 id="4、jmap"><a href="#4、jmap" class="headerlink" title="4、jmap"></a>4、jmap</h4><p>jmap—Java内存映像工具。</p><p>jmap（Memory Map for Java）命令用于生成堆转储快照（一般称为heapdump或dump文件），还可以查询finalize执行队列、Java堆和方法区的详细信息，如空间使用率、当前用的是哪种收集器等。</p><p>如果不使用jmap命令呢?</p><p>（a）使用<code>-XX：+HeapDumpOnOutOfMemoryError</code>参，可以让虚拟机在内存溢出异常出现之后自动生成堆转储快照文件。</p><p>（b）通过-XX：+HeapDumpOnCtrlBreak参数则可以使用[Ctrl]+[Break]键让虚拟机生成堆转储快照文件。</p><p>（c）在Linux系统下通过<code>Kill -3</code>命令发送进程退出信号”恐吓”一下虚拟机，也能顺利拿到堆转储快照。</p><blockquote><p>jmap有部分功能在Windows平台下是受限的，除了生成堆转储快照的-dump选项和用于查看每个类的实例、空间占用统计的-histo选项在所有操作系统中都可以使用之外，其余选项都只能在Linux/Solaris中使用。</p></blockquote><p>jmap命令格式：</p><pre class="language-bash"><code class="language-bash">jmap <span class="token punctuation">[</span> option <span class="token punctuation">]</span> vmid</code></pre><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-options-jmap.jpg" alt="jmap主要选项"></p><p>使用jmap生成一个正在运行的Eclipse的堆转储快照文件，12109是通过jps命令查询到的LVMID。</p><pre class="language-bash"><code class="language-bash">jmap -dump:format<span class="token operator">=</span>b,file<span class="token operator">=</span>eclipse.bin 12109
Dumping heap to D:\eclipse.bin <span class="token punctuation">..</span>.
Heap dump <span class="token function">file</span> created</code></pre><h4 id="5、jhat"><a href="#5、jhat" class="headerlink" title="5、jhat"></a>5、jhat</h4><p>jhat虚拟机堆转储快照分析工具。</p><p>JDK提供jhat（JVM Heap Analysis Tool）命令与jmap搭配使用，来分析jmap生成的堆转储快照。jhat内置了一个微型的HTTP/Web服务器，生成堆转储快照的分析结果后，可以在浏览器中查看。</p><blockquote><p>分析工作是一个耗时而且极为耗费硬件资源的过程，一般不直接在应用服务器上这么搞。</p><p>jhat的分析功能相对来说比较简陋，与VisualVM，以及专业用于分析堆转Eclipse Memory Analyzer、IBM HeapAnalyzer等相比。</p></blockquote><p>使用jhat分析dump文件：</p><pre class="language-bash"><code class="language-bash">jhat eclipse.bin
Reading from eclipse.bin<span class="token punctuation">..</span>.
Dump <span class="token function">file</span> created Fri Nov 19 22:07:21 CST 2010
Snapshot read, resolving<span class="token punctuation">..</span>.
Resolving 1225951 objects<span class="token punctuation">..</span>.
Chasing references, <span class="token function">expect</span> 245 dots<span class="token punctuation">..</span><span class="token punctuation">..</span>
Eliminating duplicate references<span class="token punctuation">..</span>.
Snapshot resolved.
Started HTTP server on port 7000
Server is ready.</code></pre><p>分析结果默认以包为单位进行分组显示，分析内存泄漏问题主要会使用到其中的”Heap Histogram”（与<code>jmap -histo</code>功能一样）与OQL页签的功能，前者可以找到内存中总容量最大的对象，OQL是标准的对象查询语言，使用类似SQL的语法对内存中的对象进行查询统计。关于OQL<a href=""> 《JVM的对象查询OQL》</a></p><h4 id="6、jstack"><a href="#6、jstack" class="headerlink" title="6、jstack"></a>6、jstack</h4><p>jstack：Java堆栈跟踪工具。</p><p>jstack（Stack Trace for Java）命令用于生成虚拟机当前时刻的线程快照（一般称为threaddump或者javacore文件）。</p><p>线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合。</p><p>生成线程快照的目的通常是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间挂起等，都是导致线程长时间停顿的常见原因。线程出现停顿时通过jstack来查看各个线程的调用堆栈，就可以获知没有响应的线程到底在后台做些什么事情，或者等待着什么资源。</p><p>jstack命令格式：</p><pre><code>jstack  [ option ] vmid</code></pre><p>jstack工具主要选项:</p><table><thead><tr><th align="center">选项</th><th align="left">作用</th></tr></thead><tbody><tr><td align="center">-F</td><td align="left">当正常输出的请求不被响应时，强制输出线程堆栈</td></tr><tr><td align="center">-l</td><td align="left">除堆栈外，显示关于锁的附加信息</td></tr><tr><td align="center">-m</td><td align="left">如果遇到本地方法的话，可以显示C/C++的堆栈</td></tr></tbody></table><blockquote><p>从JDK 5起，java.lang.Thread类新增了一个getAllStackTraces()方法用于获取虚拟机中所有线程的StackTraceElement对象。使用这个方法可以通过简单的几行代码完成jstack的大部分功能，在实际项目中不妨调用这个方法做个管理员页面，可以随时使用浏览器来查看线程堆栈。</p></blockquote><p>查看线程状况的JSP页面：</p><pre class="language-html"><code class="language-html">&lt;%@ page import="java.util.Map"%>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>服务器线程信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span>
    <span class="token attr-name">for</span> <span class="token attr-name">(Map.Entry&lt;Thread,</span> <span class="token attr-name">StackTraceElement[]</span><span class="token punctuation">></span></span> stackTrace : Thread.getAllStack-Traces().entrySet()) {
        Thread thread = (Thread) stackTrace.getKey();
        StackTraceElement[] stack = (StackTraceElement[]) stackTrace.getValue();
        if (thread.equals(Thread.currentThread())) {
            continue;
        }
        out.print("\n线程：" + thread.getName() + "\n");
        for (StackTraceElement element : stack) {
            out.print("\t"+element+"\n");
        }
    }
%>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h4 id="7、其他"><a href="#7、其他" class="headerlink" title="7、其他"></a>7、其他</h4><p>基础工具：</p><p>用于支持基本的程序创建和运行。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-list.jpg" alt="基础工具"></p><p>安全：</p><p>用于程序签名、设置安全测试等。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-anquan.jpg" alt="安全工具"></p><p>国际化：</p><p>用于创建本地语言文件。</p><table><thead><tr><th align="center">名称</th><th>主要作用</th></tr></thead><tbody><tr><td align="center">native2ascii</td><td>本地编码到ASCII编码的转换器（Native-to-ASCII Converter）用于”任意受支持的字符编码”和与之对应的”ASCII编码和Unicode转义”之间的相互转换。</td></tr></tbody></table><p>远程方法调用：</p><p>用于跨Web或网络的服务交互。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-rmi.jpg" alt="远程方法调用工具"></p><p>Java IDL与RMI-IIOP：在JDK 11中结束了十余年的CORBA支持，这些工具不再提供。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-idl.jpg" alt="Java IDL与RMI-IIOP"></p><p>部署工具：用于程序打包、发布和部署。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-deploy.jpg" alt="Java IDL与RMI-IIOP"></p><p>Java Web Start：</p><table><thead><tr><th align="center">名称</th><th align="center">主要作用</th></tr></thead><tbody><tr><td align="center">javaws</td><td align="center">启动Java Web Start并设置各种选项的工具。jdk11已移除。</td></tr></tbody></table><p>性能监控和故障处理：</p><p>用于监控分析Java虚拟机运行信息，排查问题。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-contrl.jpg" alt="性能监控和故障处理"></p><p>WebService工具：</p><p>与CORBA一起在JDK 11中被移除。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-webservice.jpg" alt="WebService工具"></p><p>REPL和脚本工具:</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-repl.jpg" alt="REPL和脚本工具"></p><h3 id="二、可视化故障处理工具"><a href="#二、可视化故障处理工具" class="headerlink" title="二、可视化故障处理工具"></a>二、可视化故障处理工具</h3><p>JDK中除了附带大量的命令行工具外，还提供了几个功能集成度更高的可视化工具，可以使用这些可视化工具以更加便捷的方式进行进程故障诊断和调试工作。</p><p>这类工具主要包括JConsole、JHSDB、VisualVM和JMC四个。</p><p>JConsole、JHSDB是jdk正式成员，无须独立下载，使用完全免费。</p><p>VisualVM 已不是JDK中的正式成员，但仍是可以免费下载、使用。</p><p>Java Mission Control ： JMC需要与HotSpot内部的”飞行记录仪”（Java Flight Recorder，JFR）配合才能工作，而在JDK 11以前，JFR的开启必须解锁OracleJDK的商业特性支持（使用JCMD的VM.unlock_commercial_features或启动时加入-XX：+UnlockCommercialFeatures参数），在生产环境中仍然是需要付费使用。</p><h4 id="1、JHSDB"><a href="#1、JHSDB" class="headerlink" title="1、JHSDB"></a>1、JHSDB</h4><p>JHSDB基于服务性代理的调试工具。</p><p>JDK中提供了JCMD和JHSDB两个集成式的多功能工具箱，整合基础处理工具，更强大。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-compare.jpg" alt="JCMD、JHSDB和基础工具的对比"></p><p>工具的命令模式基本相似。使用时借助<code>help</code>选项使用。</p><p>JHSDB是一款基于服务性代理（Serviceability Agent，SA）实现的进程外调试工具。</p><p>原理：</p><blockquote><p>服务性代理是HotSpot虚拟机中一组用于映射Java虚拟机运行信息的、主要基于Java语言（含少量JNI代码）实现的API集合。服务性代理以HotSpot内部的数据结构为参照物进行设计，把这些C++的数据抽象出Java模型对象，相当于HotSpot的C++代码的一个镜像。通过服务性代理的API，可以在一个独立的Java虚拟机的进程里分析其他HotSpot虚拟机的内部数据，或者从HotSpot虚拟机进程内存中dump出来的转储快照里还原出它的运行状态细节。服务性代理的工作原理跟Linux上的GDB或者Windows上的Windbg是相似的。</p></blockquote><p>（JHSDB本身对压缩指针的支持存在很多缺陷，建议用64位系统的实验时禁用压缩指针）</p><pre><code>-Xmx10m -XX:+UseSerialGC 
-XX:-UseCompressedOops</code></pre><p>程序执行后通过jsp查询到测试查询进程ID：</p><pre><code>jps -l  //查看进程id
jhsdb hsdb --pid 10987 //打开图形化界面</code></pre><p>Tools-&gt;Heap Parameters 可以看到堆的相关参数。</p><p>Heap Parameters窗口中清楚列出了新生代的Eden、S1、S2和老年代的容量（单位为字节）以及它们的虚拟内存地址起止范围。</p><p>使用JDK默认的G1的话，得到的信息应该类似如下所示</p><pre><code>Heap Parameters:
garbage-first heap [0x00007f32c7800000, 0x00007f32c8200000] region size 1024K</code></pre><p>Windows-&gt;Console窗口，使用scanoops命令在Java堆的新生代（从Eden起始地址到To Survivor结束地址）范围内查找ObjectHolder的实例。</p><pre class="language-txt"><code class="language-txt">hsdb>scanoops 0x00007f32c7800000 0x00007f32c7b50000 JHSDB_TestCase$ObjectHolder
0x00007f32c7a7c458 JHSDB_TestCase$ObjectHolder
0x00007f32c7a7c480 JHSDB_TestCase$ObjectHolder
0x00007f32c7a7c490 JHSDB_TestCase$ObjectHolder</code></pre><p>一般可以通过观察起始地址，判断实例对象分配在哪个区。</p><p>Tools-&gt;Inspector功能可以确认一下虚拟内存地址中存放的对象。</p><p>Inspector为我们展示了对象头和指向对象元数据的指针，里面包括了Java类型的名字、继承关系、实现接口关系，字段信息、方法信息、运行时常量池的指针、内嵌的虚方法表（vtable）以及接口方法表（itable）等。</p><p>Tools-&gt;Compute Reverse Ptrs 可以根据堆中对象实例地址找出引用它们的指针。</p><p>命令行也可以实现该功能：<code>revptrs 0x0007f32cdf785</code></p><p>（revptrs命令并不支持查找栈上的指针引用）</p><blockquote><p>JDK 7及其以后版本的HotSpot虚拟机选择把静态变量与类型在Java语言一端的映射Class对象存放在一起，存储于Java堆之中。</p></blockquote><p>Java Thread窗口选中main线程后点击Stack Memory按钮查看该线程的栈内存。</p><p>线程信息、栈帧信息、以及JHSDB自动生成的注释信息。</p><h4 id="2、-JConsole"><a href="#2、-JConsole" class="headerlink" title="2、 JConsole"></a>2、 JConsole</h4><p>JConsole：Java监视与管理控制台。</p><p>JConsole（Java Monitoring and Management Console）是一款基于JMX（Java Manage-ment Extensions）的可视化监视、管理工具。它的主要功能是通过JMX的MBean（Managed Bean）对系统进行信息收集和参数动态调整。</p><blockquote><p>JMX是一种开放性的技术，不仅可以用在虚拟机本身的管理上，还可以运行于虚拟机之上的软件中，典型的如中间件大多也基于JMX来实现管理与监控。虚拟机对JMX MBean的访问也是完全开放的，可以使用代码调用API、支持JMX协议的管理控制台，或者其他符合JMX规范的软件进行访问。</p></blockquote><p>（1）启动JConsole</p><p>通过JDK/bin目录下的jconsole.exe启动JCon-sole后，会自动搜索出本机运行的所有虚拟机进程，而不需要用户自己使用jps来查询。图片就不放了。</p><p>双击选择其中一个进程便可进入主界面开始监控。JMX支持跨服务器的管理，也可以使用下面的”远程进程”功能来连接远程服务器，对远程虚拟机进行监控。</p><p>进入JConsole主界面，可以看到主界面里共包括”概述””内存””线程””类””VM摘要””MBean”六个页签，”概述”页签里显示的是整个虚拟机主要运行数据的概览信息，包括”堆内存使用情况””线程””类””CPU使用情况”四项信息的曲线图。</p><p>（2）内存监控</p><p>“内存”页签的作用相当于可视化的jstat命令，用于监视被收集器管理的虚拟机内存（被收集器直接管理的Java堆和被间接管理的方法区）的变化趋势。</p><p>运行测试可以设置一下虚拟机参数（也可以不设置）</p><p><code>-Xms100m -Xmx100m -XX:+UseSerialGC</code></p><pre class="language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 内存占位符对象，一个OOMObject大约占64KB
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OOMObject</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> placeholder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fillHeap</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
    List<span class="token operator">&lt;</span>OOMObject<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>OOMObject<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 稍作延时，令监视曲线的变化更加明显</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OOMObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    <span class="token function">fillHeap</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>这段代码的作用是以64KB/50ms的速度向Java堆中填充数据，一共填充1000次，使用JConsole的”内存”页签进行监视，观察曲线和柱状指示图的变化。</p><p>程序运行后，在”内存”页签中应该可以看到内存池Eden区的运行趋势呈现折线状。</p><p>虚拟机启动参数只限制了Java堆为100MB，但没有明确使用-Xmn参数指定新生代大小，在没有设置-XX：SurvivorRadio参数时，Eden与Survivor空间比例的默认值为8∶1。</p><p>一般默认情况下，新生代约占堆内存的的1/3，老年代约占2/3。</p><p>可以从页签的信息上得到验证。</p><p>System.gc()；不保证一定进行回收。</p><h4 id="3、线程监控"><a href="#3、线程监控" class="headerlink" title="3、线程监控"></a>3、线程监控</h4><p>“线程”页签的功能就相当于可视化的jstack命令。</p><p>遇到线程停顿的时候可以使用这个页签的功能进行分析。。</p><pre><code>/**
 * 线程死循环演示
 */
public static void createBusyThread() {
Thread thread = new Thread(new Runnable() {
    @Override
    public void run() {
        while (true)   // 第41行
            ;
    }
}, &quot;testBusyThread&quot;);
thread.start();
}

/**
 * 线程锁等待演示
 */
public static void createLockThread(final Object lock) {
Thread thread = new Thread(new Runnable() {
    @Override
    public void run() {
        synchronized (lock) {
            try {
                lock.wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}, &quot;testLockThread&quot;);
thread.start();
}

public static void main(String[] args) throws Exception {
    BufferedReader br = new BufferedReader(new InputStreamReader(System.in));
    br.readLine();
    createBusyThread();
    br.readLine();
    Object obj = new Object();
    createLockThread(obj);
}</code></pre><p>程序运行后，首先在”线程”页签中选择main线程。</p><blockquote><p>堆栈追踪显示BufferedReader的readBytes()方法正在等待System.in的键盘输入，这时候线程为Runnable状态，Runnable状态的线程仍会被分配运行时间，但readBytes()方法检查到流没有更新就会立刻归还执行令牌给操作系统，这种等待只消耗很小的处理器资源。</p></blockquote><p>监控testBusyThread线程。testBusyThread线程一直在执行空循环，从堆栈追踪中看到一直在MonitoringTest.java代码的41行停留，41行的代码为while(true)。这时候线程为Runnable状态，而且没有归还线程执行令牌的动作，所以会在空循环耗尽操作系统分配给它的执行时间，直到线程切换为止，这种等待会消耗大量的处理器资源。</p><p>未完。。。。</p><h4 id="4、VisualVM"><a href="#4、VisualVM" class="headerlink" title="4、VisualVM"></a>4、VisualVM</h4><p>VisualVM：多合-故障处理工具。</p><p>VisualVM（All-in-One Java Troubleshooting Tool）是功能最强大的运行监视和故障处理程序之一，曾经在很长一段时间内是Oracle官方主力发展的虚拟机故障处理工具。</p><p>它除了常规的运行监视、故障处理外，还将提供其他方面的能力，譬如性能分析（Profiling）。VisualVM的性能分析功能比起JProfiler、YourKit等专业且收费的Profiling工具都不遑多让。</p><p>它的通用性很强，对应用程序实际性能的影响也较小，使得它可以直接应用在生产环境中。</p><p>（1）VisualVM兼容范围与插件安装</p><p>VisualVM基于NetBeans平台开发工具，所以一开始它就具备了通过插件扩展功能的能力，有了插件扩展支持，VisualVM可以做到：</p><p>​ （a）显示虚拟机进程以及进程的配置、环境信息（jps、jinfo）。</p><p>​ （b）监视应用程序的处理器、垃圾收集、堆、方法区以及线程的信息（jstat、jstack）。</p><p>​ （c）dump以及分析堆转储快照（jmap、jhat）。</p><p>​ （d）方法级的程序运行性能分析，找出被调用最多、运行时间最长的方法。</p><p>​ （e）离线程序快照：收集程序的运行时配置、线程dump、内存dump等信息建立一个快照，可以将快照发送开发者处进行Bug反馈。</p><p>​ （f）其他插件带来的无限可能性。</p><p>VisualVM在JDK 6 Update 7中首次发布，但并不意味着它只能监控运行于JDK 6上的程序，它具备很优秀的向下兼容性，甚至能向下兼容至2003年发布的JDK 1.4.2版本。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-jvisVM.jpg" alt="VisualVM主要功能兼容性列表"></p><p>VisualVM的插件安装：</p><p>（A）手工进行安装</p><p>VisualVM的插件可以手工进行安装，在网站[插图]上下载nbm包后，点击”工具-&gt;插件-&gt;已下载”菜单，然后在弹出对话框中指定nbm包路径便可完成安装。独立安装的插件存储在VisualVM的根目录，譬如JDK 9之前自带的VisulalVM，插件安装后是放在JDK_HOME/lib/visualvm中的。</p><p>（B）自动安装</p><p>VisualVM的自动安装功能已可找到大多数所需的插件，在有网络连接的环境下，点击”工具-&gt;插件菜单”，在页签的”可用插件”及”已安装”中列举了当前版本VisualVM可以使用的全部插件，选中插件后在右边窗口会显示这个插件的基本信息，如开发者、版本、功能描述等。</p><p>VisualVM中”概述””监视””线程””MBeans”的功能与Jconsole相似。</p><p>（2）生成、浏览堆转储快照</p><p>在VisualVM中生成堆转储快照文件有两种方式，</p><p>​ a）在”应用程序”窗口中右键单击应用程序节点，然后选择”堆Dump”。</p><p>​ b）在”应用程序”窗口中双击应用程序节点以打开应用程序标签，然后在”监视”标签中单击”堆Dump”。</p><p>生成堆转储快照文件之后，应用程序页签会在该堆的应用程序下增加一个以[heap-dump]开头的子节点，并且在主页签中打开该转储快照。</p><blockquote><p>如果需要把堆转储快照保存或发送出去，就应在heapdump节点上右键选择”另存为”菜单，否则当VisualVM关闭时，生成的堆转储快照文件会被当作临时文件自动清理掉。要打开一个由已经存在的堆转储快照文件，通过文件菜单中的”装入”功能，选择文件即可。</p></blockquote><p>堆页签中的”摘要”面板可以看到应用程序dump时的运行时参数、System.getPro-perties()的内容、线程堆栈等信息；</p><p>“类”面板则是以类为统计口径统计类的实例数量、容量信息；</p><p>“实例”面板不能直接使用，因为VisualVM在此时还无法确定用户想查看哪个类的实例，所以需要通过”类”面板进入，在”类”中选择一个需要查看的类，然后双击即可在”实例”里面看到此类的其中500个实例的具体属性信息；</p><p>“OQL控制台”面板则是运行OQL查询语句的，同jhat中介绍的OQL功能一样。</p><p>（3）分析程序性能</p><p>在Profiler页签中，VisualVM提供了程序运行期间方法级的处理器执行时间分析以及内存分析。做Profiling分析肯定会对程序运行性能有比较大的影响，所以一般不在生产环境使用这项功能，或者改用JMC来完成，JMC的Profiling能力更强，对应用的影响非常轻微。</p><p>要开始性能分析，先选择”CPU”和”内存”按钮中的一个，然后切换到应用程序中对程序进行操作，VisualVM会记录这段时间中应用程序执行过的所有方法。如果是进行处理器执行时间分析，将会统计每个方法的执行次数、执行耗时；如果是内存分析，则会统计每个方法关联的对象数以及这些对象所占的空间。等要分析的操作执行结束后，点击”停止”按钮结束监控过程。</p><blockquote><p>在JDK 5之后，在客户端模式下的虚拟机加入并且自动开启了类共享——这是一个在多虚拟机进程共享rt.jar中类数据以提高加载速度和节省内存的优化，而根据相关Bug报告的反映，VisualVM的Profiler功能会因为类共享而导致被监视的应用程序崩溃，所进行Profiling前，最好在被监视程序中使用-Xshare：off参数来关闭类共享优化。</p></blockquote><p>（4）BTrace动态日志跟踪</p><p>BTrace是一个很神奇的VisualVM插件，它本身也是一个可运行的独立程序。</p><p>BTrace的作用是在不中断目标程序运行的前提下，通过HotSpot虚拟机的Instrument功能[插图]动态加入原本并不存在的调试代码。这项功能对实际生产中的程序很有意义：如当程序出现问题时，排查错误的一些必要信息时（譬如方法参数、返回值等），在开发时并没有打印到日志之中以至于不得不停掉服务时，都可以通过调试增量来加入日志代码以解决问题。</p><p>在VisualVM中安装了BTrace插件后，在应用程序面板中右击要调试的程序，会出现”Trace Application…”菜单，点击将进入BTrace面板。</p><p>BTrace的功能演示：产生两个1000以内的随机整数，输出这两个数字相加的结果</p><pre class="language-java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BTraceTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        BTraceTest test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BTraceTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BufferedReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>这段程序已经上线运行，而我们现在又有了新的需求，想要知道程序中生成的两个随机数是什么，但程序并没有在执行过程中输出这一点。此时，在VisualVM中打开该程序的监视，在BTrace页签填充TracingScript的内容，输入调试代码，即可在不中断程序运行的情况下做到这一点。</p><pre><code>/* BTrace Script Template */
import com.sun.btrace.annotations.*;
import static com.sun.btrace.BTraceUtils.*;

@BTrace
public class TracingScript {
        @OnMethod(
    clazz=&quot;org.fenixsoft.monitoring.BTraceTest&quot;,
    method=&quot;add&quot;,
    location=@Location(Kind.RETURN)
)

public static void func(@Self org.fenixsoft.monitoring.BTraceTest instance,int a, int b,@Return int result) {
    println(&quot;调用堆栈:&quot;);
    jstack();
    println(strcat(&quot;方法参数A:&quot;,str(a)));
    println(strcat(&quot;方法参数B:&quot;,str(b)));
    println(strcat(&quot;方法结果:&quot;,str(result)));
}
}</code></pre><p>点击Start按钮后稍等片刻，编译完成后，Output面板中会出现”BTracecode successfuly deployed”的字样。当程序运行时将会在Output面板输出调试信息。</p><p>BTrace的用途很广泛，打印调用堆栈、参数、返回值只是它最基础的使用形式，使用BTrace进行性能监视、定位连接泄漏、内存泄漏、解决多线程竞争问题等。</p><p>BTrace能够实现动态修改程序行为，是因为它是基于Java虚拟机的Instrument开发的。Instrument是Java虚拟机工具接口（Java VirtualMachine Tool Interface，JVMTI）的重要组件，提供了一套代理（Agent）机制，使得第三方工具程序可以以代理的方式访问和修改Java虚拟机内部的数据。</p><blockquote><p>阿里巴巴开源的诊断工具Arthas也通过Instrument实现了与BTrace类似的功能。</p></blockquote><p>4、Java Mission Control</p><p>Java Mission Control：可持续在线的监控工具。</p><p>Oracle Java SE Advanced &amp; Suite[插图]与普通OracleJava SE在功能上的主要差别是前者包含了一系列的监控、管理工具，譬如用于企业JRE定制管理的AMC（Java Advanced ManagementConsole）控制台、JUT（Java Usage Tracker）跟踪系统，用于持续收集数据的JFR（Java Flight Recorder）飞行记录仪和用于监控Java虚拟机的JMC（Java Mission Control）。这些功能全部都是需要商业授权才能在生产环境中使用，但根据Oracle Binary Code协议，在个人开发环境中，允许免费使用JMC和JFR。</p><p>JFR特点：</p><p>（1）JFR是一套内建在HotSpot虚拟机里面的监控和基于事件的信息搜集框架，与其他的监控工具（如JProfiling）相比，它具有”可持续在线”（Always-On）的特性。</p><p>（2）JFR在生产环境中对吞吐量的影响一般不会高于1%（甚至号称是Zero Performance Overhead）。</p><p>（3）JFR监控过程的开始、停止都是完全可动态的，即不需要重启应用。</p><p>（4）JFR的监控对应用也是完全透明的，即不需要对应用程序的源码做任何修改，或者基于特定的代理来运行。</p><p>JMC：</p><p>（1）Eclipse RCP作为基础框架。</p><p>（2）可下载独立程序，也可以作为Eclipse插件安装。</p><p>（3）JMC与虚拟机之间同样采取JMX协议进行通信，作为JMX控制台显示来自虚拟机MBean提供的数据。</p><p>（4）JMC还可以作为JFR的分析工具，展示来自JFR的数据。</p><p><img src="/medias/loading-animated.gif" data-original="/images/jvm-tools/jvm-tools-jmc.jpg" alt="JMC主界面"></p><p>打开界面之后，双击”飞行记录器”，将会出现”启动飞行记录”窗口。</p><p>飞行记录报告里包含以下几类信息：</p><p>（a）一般信息：关于虚拟机、操作系统和记录的一般信息。</p><p>（b）内存：关于内存管理和垃圾收集的信息。</p><p>（c）代码：关于方法、异常错误、编译和类加载的信息。</p><p>（d）线程：关于应用程序中线程和锁的信息。</p><p>（e）I/O：关于文件和套接字输入、输出的信息。</p><p>（f）系统：关于正在运行Java虚拟机的系统、进程和环境变量的信息。</p><p>（g）事件：关于记录中的事件类型的信息，可以根据线程或堆栈跟踪，按照日志或图形的格式查看。</p><p>JFR工作过程：</p><p>JFR开启一系列事件的录制动作，当某个事件发生时，这个事件的所有上下文数据将会以循环日志的形式被保存至内存或者指定的某个文件当中，循环日志相当于数据流被保留在一个环形缓存中，所以只有最近发生的事件的数据才是可用的。JMC从虚拟机内存或者文件中读取并展示这些事件数据，并通过这些数据进行性能分析。</p><blockquote><p>JFR提供的数据质量通常也要比其他工具通过代理形式采样获得或者从MBean中取得的数据高得多。以垃圾搜集为例，HotSpot的MBean中一般有各个分代大小、收集次数、时间、占用率等数据（根据收集器不同有所差别），这些都属于”结果”类的信息，而JFR中还可以看到内存中这段时间分配了哪些对象、哪些在TLAB中（或外部）分配、分配速率和压力大小如何、分配归属的线程、收集时对象分代晋升的情况等，这些就是属于”过程”类的信息，对排查问题的价值是难以估量的。</p></blockquote><h3 id="三、HotSpot虚拟机插件及工具"><a href="#三、HotSpot虚拟机插件及工具" class="headerlink" title="三、HotSpot虚拟机插件及工具"></a>三、HotSpot虚拟机插件及工具</h3><p>虚拟机的插件和辅助工具存放在HotSpot源码hotspot/src/share/tools目录下：</p><p>主要有：</p><p>（1）Ideal Graph Visualizer</p><p>用于可视化展示C2即时编译器是如何将字节码转化为理想图，然后转化为机器码的。</p><p>（2）Client Compiler Visualizer</p><p>用于查看C1即时编译器生成高级中间表示（HIR），转换成低级中间表示（LIR）和做物理寄存器分配的过程。</p><p>（3）MakeDeps</p><p>帮助处理HotSpot的编译依赖的工具。</p><p>（4）Project Creator</p><p>帮忙生成Visual Studio的.project文件的工具。</p><p>（5）LogCompilation</p><p>将-XX：+LogCompilation输出的日志整理成更容易阅读的格式的工具。</p><p>（6）HSDIS</p><p>即时编译器的反汇编插件。HSDIS可以用于JIT生成代码反汇编</p><p>HSDIS是一个被官方推荐的HotSpot虚拟机即时编译代码的反汇编插件，它包含在HotSpot虚拟机的源码当中，在OpenJDK的网站[插图]也可以找到单独的源码下载。</p><p>HSDIS插件的作用是让HotSpot的-XX：+PrintAssembly指令调用它来把即时编译器动态生成的本地代码还原为汇编代码输出，同时还会自动产生大量非常有价值的注释，这样可以通过输出的汇编代码来从最本质的角度分析问题。</p><blockquote><p>需要自己下载编译好的插件，直接放到JDK_HOME/jre/bin/server目录（JDK 9以下）或JDK_HOME/lib/amd64/server（JDK 9或以上）中即可使用。如果没有找到所采用操作系统的对应编译成品，那就自己用源码编译一遍（网上能找到各种操作系统下的编译教程）。</p><p>使用SlowDebug或者FastDebug版的HotSpot，可以直接通过-XX：+PrintAssembly指令使用的插件；</p><p>如果使用Product版的HotSpot，则还要额外加入一个-XX：+UnlockDiagnosticVMOptions参数才可以工作。</p></blockquote><p>相关示例涉及汇编语言，参考《深入理解Java虚拟机第三版》第四章4.4节。</p><p>JITWatch 是HSDIS经常搭配使用的可视化的编译日志分析工具，为便于在JITWatch中读取，可使用以下参数把日志输出到logfile文件。</p><pre class="language-txt"><code class="language-txt">-XX:+UnlockDiagnosticVMOptions
-XX:+TraceClassLoading
-XX:+LogCompilation
-XX:LogFile=/tmp/logfile.log
-XX:+PrintAssembly
-XX:+TraceClassLoading</code></pre><p>在JITWatch中加载日志后，就可以看到执行期间使用过的各种对象类型和对应调用过的方法了，选择想要查看的类和方法，即可查看对应的Java源代码、字节码和即时编译器生成的汇编代码。</p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">Small-Rose / 张小菜</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://small-rose.github.io/posts/ed0fd586.html">https://small-rose.github.io/posts/ed0fd586.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">Small-Rose / 张小菜</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/JVM/"><span class="chip bg-color">JVM</span> </a><a href="/tags/%E7%9B%91%E6%8E%A7%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7/"><span class="chip bg-color">监控调优工具</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22AB38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019FE8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/gitalk/gitalk.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/css/my-gitalk.css"><div class="card gitalk-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="gitalk-container" class="card-content"></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/gitalk/gitalk.min.js"></script><script>let gitalk = new Gitalk({
        clientID: '25d0a50a89b8a9328515',
        clientSecret: '87ad6a6e64a7b5727d9c9f5f049f5a28bf714dcc',
        repo: 'small-rose.github.io',
        owner: 'small-rose',
        admin: "small-rose",
        id: '2020-06-09T00-00-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/d22e90ef.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/featureimages/9.jpg" class="responsive-img" alt="DB2常用函数"> <span class="card-title">DB2常用函数</span></div></a><div class="card-content article-content"><div class="summary block-with-text">本文记录整理DB2常用命令。</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-06-10 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/DB2/" class="post-category">DB2</a></span></div></div><div class="card-action article-tags"><a href="/tags/DB2/"><span class="chip bg-color">DB2</span> </a><a href="/tags/SQL/"><span class="chip bg-color">SQL</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/6698cab3.html"><div class="card-image"><img src="/images/jvm-logo.jpg" class="responsive-img" alt="jvm之类文件结构"> <span class="card-title">jvm之类文件结构</span></div></a><div class="card-content article-content"><div class="summary block-with-text">本文记录JVM类文件结构学习。</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-06-09 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/JVM/" class="post-category">JVM</a></span></div></div><div class="card-action article-tags"><a href="/tags/JVM/"><span class="chip bg-color">JVM</span> </a><a href="/tags/class%E7%BB%93%E6%9E%84/"><span class="chip bg-color">class结构</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){if("undefined"!=typeof window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("120"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>");var i=document.location.href;o.innerHTML+='<br />来源: 张小菜苔<br />文章作者: Small Rose / 张小菜<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)}}})</script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{display:none;font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{display:none;font-size:15px;color:#42b983}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="netease" type="playlist" id="503838841" fixed="true" autoplay theme="#42b983" loop order="random" preload="auto" volume="0.7" list-folded="true"></meting-js></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2020</span> <a href="/about" target="_blank">Small Rose / 张小菜</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">176.3k</span>&nbsp;字 <span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><span id="sitetime">载入运行时间...</span><script>function siteTime(){var e=1e3,t=60*e,n=60*t,o=24*n,r=365*o,a=new Date,i="2020",l="5",m="1",M="0",g="0",d="0",s=a.getFullYear(),u=a.getMonth()+1,T=a.getDate(),c=a.getHours(),f=a.getMinutes(),h=a.getSeconds(),y=Date.UTC(i,l,m,M,g,d),H=Date.UTC(s,u,T,c,f,h),I=H-y,B=Math.floor(I/r),D=Math.floor(I/o-365*B),E=Math.floor((I-(365*B+D)*o)/n),L=Math.floor((I-(365*B+D)*o-E*n)/t),v=Math.floor((I-(365*B+D)*o-E*n-L*t)/e);i==s?(document.getElementById("year").innerHTML=s,document.getElementById("sitetime").innerHTML="本站已安全运行 "+D+" 天 "+E+" 小时 "+L+" 分钟 "+v+" 秒"):(document.getElementById("year").innerHTML=i+" - "+s,document.getElementById("sitetime").innerHTML="本站已安全运行 "+B+" 年 "+D+" 天 "+E+" 小时 "+L+" 分钟 "+v+" 秒")}setInterval(siteTime,1e3)</script><br><span id="icp"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/icp.png" style="vertical-align:text-bottom"> <a href="http://beian.miit.gov.cn/" target="_blank">鄂ICP备19015637号</a></span></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/small-rose" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:small-rose@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=970175021" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 970175021" data-position="top" data-delay="50"><i class="fab fa-qq"></i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/search.js"></script><script type="text/javascript">$(function(){searchFunc("https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/materialize/materialize.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/masonry/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/aos/aos.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/scrollprogress/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/matery.js"></script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/others/clicklove.js" async></script><script async src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/others/busuanzi.pure.mini.js"></script><script type="text/javascript" size="150" alpha="0.6" zindex="-1" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/background/ribbon-refresh.min.js" async></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/instantpage/instantpage.js" type="module"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/funnyTitle.js" type="module"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/sakura.js" type="module"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/fullscreen.js" type="module"></script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var i=n.imageLazyLoadSetting.isSPA,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){i&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,e,a=0;a<r.length;a++)t=r[a],0<=(e=t.getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(n.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},n.src=i}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html><!-- rebuild by neat -->