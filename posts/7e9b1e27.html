<!-- build time:Thu Jan 07 2021 17:03:38 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="keywords" content="spring batch,spring 批处理框架,springboot batch,springboot 批处理,spring batch job上下文,spring batch step上下文,spring batch 监听器,spring batch 执行上下文,spring batch itemreader,spring batch itemwriter,spring batch processor,spring batch schedule,spring batch web restful,spring batch xml"><meta name="description" content="个人技术笔记，记录学习/开发问题"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>Spring batch | 张小菜苔</title><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/css/matery.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/css/my.css"><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/jquery/jquery.min.js"></script><script type="text/javascript">window.$crisp=[],window.CRISP_WEBSITE_ID="0c0bcdb7-097e-402f-bb6b-9cf042148a9e",function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)}()</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="张小菜苔" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><div><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/logo-3.png" class="logo-img" alt="LOGO"> <span class="logo-span diyFont">张小菜苔</span></div></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home"></i><span>主</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags"></i><span>签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark"></i><span>类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive"></i><span>档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle"></i><span>吾</span></a></li><li class="hide-on-med-and-down nav-item"><a href="https://zhangxiaocai.cn/contact" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fas fa-comments"></i><span>言</span></a></li><li class="hide-on-med-and-down nav-item"><a href="https://zhangxiaocai.cn/artitalk" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fas fa-heartbeat"></i><span>语</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book"></i><span>友</span></a></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fas fa-list"></i> <span>秘</span> <i class="fas fa-chevron-down" aria-hidden="true"></i></a><ul class="sub-nav menus_item_child"><li><a href="/navigate"><i class="fas fa-location-arrow" style="margin-top:-20px"></i> <span>风域之门</span></a></li><li><a href="/box"><i class="fas fa-map-marker" style="margin-top:-20px"></i> <span>妖魔化镜</span></a></li><li><a href="https://hut.zhangxiaocai.cn" target="_blank" rel="noopener"><i class="fas fa-pen-alt" style="margin-top:-20px"></i> <span>沧海成渊</span></a></li><li><a href="https://yun.zhangxiaocai.cn" target="_blank" rel="noopener"><i class="fas fa-cloud" style="margin-top:-20px"></i> <span>云上之城</span></a></li></ul></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索"></i></a></li><li id="fullscreen_li" class="fullscreen"><a href="javascript:void(0);" class="modal-trigger waves-effect waves-light"><i id="fullscreen" class="fa fa-expand-arrows-alt" title="全屏"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/logo-3.png" class="logo-img circle responsive-img"><div class="logo-name">张小菜苔</div><div class="logo-desc">个人技术笔记，记录学习/开发问题</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="https://zhangxiaocai.cn/contact" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言薄</a></li><li class="m-nav-item"><a href="https://zhangxiaocai.cn/artitalk" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fa-fw fas fa-heartbeat"></i> ArtiTalk</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-list"></i> Secret <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/navigate" style="margin-left:75px"><i class="fa fas fa-location-arrow" style="position:absolute;left:50px"></i> <span>风域之门</span></a></li><li><a href="/box" style="margin-left:75px"><i class="fa fas fa-map-marker" style="position:absolute;left:50px"></i> <span>妖魔化镜</span></a></li><li><a href="https://hut.zhangxiaocai.cn" target="_blank" rel="noopener" style="margin-left:75px"><i class="fa fas fa-pen-alt" style="position:absolute;left:50px"></i> <span>沧海成渊</span></a></li><li><a href="https://yun.zhangxiaocai.cn" target="_blank" rel="noopener" style="margin-left:75px"><i class="fa fas fa-cloud" style="position:absolute;left:50px"></i> <span>云上之城</span></a></li></ul></li></ul></div></div></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/featureimages/15.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">Spring batch</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:32px;bottom:155px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/Spring-batch/"><span class="chip bg-color">Spring batch</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/SpringBoot/" class="post-category">SpringBoot</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2020-12-12</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 8.4k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp; 35 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><blockquote><p>分类说明，Spring batch 属于sping框架，而非springboot，但因为现在多使用springboot开发，并且本文案例也是基于springboot的，所以就放到SpringBoot类目下。</p></blockquote><h2 id="spring-batch"><a href="#spring-batch" class="headerlink" title="spring-batch"></a>spring-batch</h2><blockquote><p>Spring Batch是处理大量数据操作的一个框架，主要用来读取大量数据，然后进行一定的处理后，按照指定的形式回写或者输出。</p></blockquote><p>任务存储仓库可以是关系型数据库MySQL，非关系型数据库MongoDB或者直接存储在内存中</p><h2 id="一、基本原理"><a href="#一、基本原理" class="headerlink" title="一、基本原理"></a>一、基本原理</h2><h3 id="1、主要原理"><a href="#1、主要原理" class="headerlink" title="1、主要原理"></a>1、主要原理</h3><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/spring-batch-01.png" alt="spring-batch 基本原理图"></p><p>Spring Batch里最基本的单元就是任务Job，一个Job由若干个步骤Step组成。任务启动器Job Launcher负责运行Job，任务存储仓库Job Repository存储着Job的执行状态，参数和日志等信息。</p><p>Job处理任务又可以分为三大类：数据读取Item Reader、数据中间处理Item Processor和数据输出Item Writer。</p><h3 id="2、-EnableBatchProcessing"><a href="#2、-EnableBatchProcessing" class="headerlink" title="2、 @EnableBatchProcessing"></a>2、 @EnableBatchProcessing</h3><p>开启批量处理的模块化注册组件，配置的核心接口是BatchConfigurer。开启之后默认装载一下Bean组件：</p><ul><li><p><code>JobRepository</code>：bean名称 <code>jobRepository</code></p></li><li><p><code>JobLauncher</code>：bean名称 <code>jobLauncher</code></p></li><li><p><code>JobRegistry</code>：bean名称 <code>jobRegistry</code></p></li><li><p><code>PlatformTransactionManager</code>：bean名称 <code>transactionManager</code></p></li><li><p><code>JobBuilderFactory</code>：bean名称<code>jobBuilders</code></p></li><li><p><code>StepBuilderFactory</code>：bean名称<code>stepBuilders</code></p></li></ul><p>开启之后，可以使用提供的构建器工厂来配置作业。</p><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableBatchProcessing</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>DataSourceConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> JobBuilderFactory jobs<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> StepBuilderFactory steps<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> Job <span class="token function">job</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"step1"</span><span class="token punctuation">)</span> Step step1<span class="token punctuation">,</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"step2"</span><span class="token punctuation">)</span> Step step2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> jobs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"myJob"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>step1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>step2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> Step <span class="token function">step1</span><span class="token punctuation">(</span>ItemReader<span class="token operator">&lt;</span>Person<span class="token operator">></span> reader<span class="token punctuation">,</span>
                         ItemProcessor<span class="token operator">&lt;</span>Person<span class="token punctuation">,</span> Person<span class="token operator">></span> processor<span class="token punctuation">,</span>
                         ItemWriter<span class="token operator">&lt;</span>Person<span class="token operator">></span> writer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> steps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"step1"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>&lt;Person<span class="token punctuation">,</span> Person<span class="token operator">></span> <span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> Step <span class="token function">step2</span><span class="token punctuation">(</span>Tasklet tasklet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> steps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"step2"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tasklet</span><span class="token punctuation">(</span>tasklet<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><h2 id="二、核心组件"><a href="#二、核心组件" class="headerlink" title="二、核心组件"></a>二、核心组件</h2><p>Spring Batch框架7个主要组件</p><ul><li><p>1）<strong>Job</strong>： 即作业，也就是在使用过程中真处理业务数据的批处理作业。 Job 是封装整个批处理过程的实体。</p></li><li><p>2）<strong>Step</strong>：即步骤，包括：ItemReader-&gt;ItemProcessor-&gt;ItemWriter</p></li><li><p>3）JobLauncher：用来启动Job的接口</p></li><li><p>4）JobRepository：用来注册Job容器，设置数据库相关属性。</p></li><li><p>5）ItemReader：用来读取数据，做实体类与数据字段之间的映射。比如读取csv文件中的人员数据，之后对应实体person的字段做mapper</p></li><li><p>6）ItemProcessor：用来处理数据的接口，同时可以做数据校验（设置校验器，使用JSR-303(hibernate-validator)注解），比如将中文性别男/女，转为M/F。同时校验年龄字段是否符合要求等</p></li><li><p>7）ItemWriter：用来输出数据的接口，设置数据库源。编写预处理SQL插入语句</p></li></ul><p>以上七个组成部分中，Job和Step是spring batch执行批处理任务最为核心的两个概念。</p><h3 id="1、Job-作业组件"><a href="#1、Job-作业组件" class="headerlink" title="1、Job 作业组件"></a>1、Job 作业组件</h3><p>job是作为运行的基本单位，它内部由step组成。job本质上可以看成step的一个容器。<br>一个job可以按照指定的逻辑顺序组合step，并提供了我们给所有step设置相同属性的方法，例如一些事件监听，跳过策略等。<br>Job实现类主要有两种类型的job，一个是simplejob，另一个是flowjob。</p><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/job-code.jpg" alt=""></p><p>在Spring Batch中，作业Job只是Step实例的容器。它组合了逻辑上属于流程的多个Step步骤，并允许配置所有步骤全局的属性，例如可重新启动性。作业配置包含：</p><ul><li><p>作业的简单名称。</p></li><li><p>步骤实例的定义和顺序。</p></li><li><p>作业是否可重新启动。</p></li></ul><p>关于Job作业的配置称为作业配置。作业配置常见模式：</p><p><strong>Java 模式的作业配置：</strong></p><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> Job <span class="token function">multiStepJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"multiStepJob"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre><p><strong>XML 模式的作业配置：</strong></p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multiStepJob<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>step1<span class="token punctuation">"</span></span> <span class="token attr-name">next</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>step2<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>step2<span class="token punctuation">"</span></span> <span class="token attr-name">next</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>step3<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>step3<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span></code></pre><h4 id="1-1、JobInstance-作业实例"><a href="#1-1、JobInstance-作业实例" class="headerlink" title="1.1、JobInstance 作业实例"></a>1.1、JobInstance 作业实例</h4><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/job-heirarchy.png" alt=""></p><p>JobInstance是Job的更加底层的一个抽象，是指逻辑作业运行的概念。</p><blockquote><p>比如现在有一个在每天结束时运行一次的批处理作业，例如上图中的 “EndOfDay” 作业。有一个”EndOfDay”作业，但是该作业的每个单独运行都必须分别进行跟踪。对于此作业，每天有一个逻辑JobInstance。例如，有1月1日运行，1月2日运行，依此类推。如果1月1日运行第一次失败并在第二天再次运行，则仍是1月1日运行。 （通常，这也与它正在处理的数据相对应，这意味着1月1日运行处理1月1日的数据）。因此，每个JobInstance可以有多个执行，并且在给定时间只能运行一个与特定Job对应并标识JobParameters的JobInstance。</p></blockquote><p>官方的说明通俗的理解其实就是，我虽然定义了一个Job作业（相当于作业模板），但是会多次执行，每一次执行都要单独跟踪记录，不然怎么知道每次的执行情况呢？所以每次执行都会产生一个<code>JobInstance</code>，可以理解为运行记录，这个记录对应着 <code>batch_job_instance</code> 表（默认batch开头，可以自定义配置）中对应Job的记录。</p><p>JobInstance 作业实例接口，有两个方法，一个是返回Job作业实例的id，另一个是返回Job作业名称。</p><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">JobInstance</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> <span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    String <span class="token function">getJobName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><h4 id="1-2、JobParameters"><a href="#1-2、JobParameters" class="headerlink" title="1.2、JobParameters"></a>1.2、JobParameters</h4><p>JobParameters 即作业运行参数。</p><p>同一个Job作业，每天运行一次的话，那么每天都有一个jobIntsance作业实例记录，但他们的Job作业模板定义都是一样的，那么就需要一个用区别一个job作业模板执行时的不同jobinstance的标记，spring batch中提供的用来标识一个jobinstance的东西就是JobParameters 。</p><p>JobParameters对象包含一组用于启动批处理作业的参数，它可以在运行期间用于识别或甚至用作参考数据。通常运行时间，就可以作为一个JobParameters。</p><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/job-stereotypes-parameters.png" alt=""></p><p>啊哦！原来是这样，不过，我偏不信邪，我就不用运行时间作为参数标记，我偏要设置一个固定的 JobParameters。</p><p>先定义一个简单的Job作业执行模板：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>xiaocai<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>single<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * import 省略
 * @author Xiaocai.Zhang
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingleJobSingleStepDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> JobBuilderFactory jobBuilderFactory<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> StepBuilderFactory stepBuilderFactory<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     *  以Bean的形式放入ioc，本实例仅作demo使用，实际请放到单独的config中，其他同理，不再单独说明
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> Job <span class="token function">singleStepJobDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"singleStepJobDemo"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">singleStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> Step <span class="token function">singleStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"step"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tasklet</span><span class="token punctuation">(</span><span class="token punctuation">(</span>contribution<span class="token punctuation">,</span> chunkContext<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"----this is my first job ...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> RepeatStatus<span class="token punctuation">.</span>FINISHED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>为了不让这个Job启动工程就执行，先将默认的工程启动立即执行<code>spring.batch.job.enabled</code>配置设置为<code>false</code></p><pre class="language-yml"><code class="language-yml">server:
  port: 8806
#-------------------
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/springboot_batch?serverTimezone=GMT%2b8&useSSL=true&Unicode=true&characterEncoding=utf8&autoReconnectForPools=true&allowMultiQueries=true&rewriteBatchedStatements=true
    username: root
    password: 123456

# 默认是启动时执行一次，设置为false，表示启动不执行，可以通过 web等其他请求调用方式执行
  batch:
    job:
      enabled: false  #是否自动执行定义的Job，默认是
      names:  # 启动是要执行的job
    initialize-schema: never # 是否初始化Spring Batch的数据库，ALWAYS,EMBEDDED,NEVER
    schema:    # 默认有对应的sql脚本
    table-prefix: batch_  # 设置Spring Batch的数据库表的前缀

#-------------------
scheduled:
  enabled: false
</code></pre><p>为了模拟真实场景测试，我写个<code>controller</code>来模拟真实调用：</p><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"不变参数重复调用测试接口"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/single/noParameters"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">noParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        JobParameters jobParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobParametersBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addString</span><span class="token punctuation">(</span><span class="token string">"testKey"</span><span class="token punctuation">,</span><span class="token string">"testValue"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toJobParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobLauncher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>singleStepJobDemo<span class="token punctuation">,</span> jobParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"The noParameters job is proceed."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre><p>我这里偏要给一个永远固定的 JobParameters，看他又能把我咋样？</p><pre class="language-java"><code class="language-java"> JobParameters jobParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobParametersBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addString</span><span class="token punctuation">(</span><span class="token string">"testKey"</span><span class="token punctuation">,</span><span class="token string">"testValue"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toJobParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>启动工程访问测试API: <code>http://localhost:8806/job/single/noParameters</code></p><p>第1次执行结果：</p><pre class="language-txt"><code class="language-txt">2020-12-09 15:52:48.105  INFO 15500 --- [nio-8806-exec-8] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=singleStepJobDemo]] launched with the following parameters: [{testKey=testValue}]
2020-12-09 15:52:48.122  INFO 15500 --- [nio-8806-exec-8] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]
2020-12-09 15:52:48.131  INFO 15500 --- [nio-8806-exec-8] c.x.b.single.SingleJobSingleStepDemo     : ----this is my first job ....
2020-12-09 15:52:48.138  INFO 15500 --- [nio-8806-exec-8] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 16ms</code></pre><p>顺利执行了。</p><p>第2次执行结果：</p><pre class="language-txt"><code class="language-txt">2020-12-09 15:52:56.200 ERROR 15500 --- [nio-8806-exec-2] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.batch.core.repository.JobInstanceAlreadyCompleteException: A job instance already exists and is complete for parameters={testKey=testValue}.  If you want to run this job again, change the parameters.] with root cause

org.springframework.batch.core.repository.JobInstanceAlreadyCompleteException: A job instance already exists and is complete for parameters={testKey=testValue}.  If you want to run this job again, change the parameters.
    at org.springframework.batch.core.repository.support.SimpleJobRepository.createJobExecution(SimpleJobRepository.java:132) ~[spring-batch-core-4.3.0.jar:4.3.0]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_212]
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_212]
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_212]
    at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_212]
    at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:344) ~[spring-aop-5.3.1.jar:5.3.1]</code></pre><p>可以看到 <code>SimpleJobRepository</code>的<code>createJobExecution(String jobName, JobParameters jobParameters)</code>方法会抛出错误信息：<code>JobInstanceAlreadyCompleteException: A job instance already exists and is complete for parameters={testKey=testValue}. If you want to run this job again, change the parameters.</code></p><p><strong>结论</strong><br>（1）JobInstance = Job + jobParameters 标识。</p><p>（2）jobParameters 作业参数 搭配 Job 作业模板执行才能产生一个 JobInstance 。</p><p>（3）而 Job 作业模板基本上一开始就定义好的，所以可以通过Jobparameter来操作正确的JobInstance，在通俗的意义上理解将Jobparameter 作业参数 和JobInstance 作业实例看成一一对应的。</p><blockquote><p>注意：并非所有作业参数都需要用于标识JobInstance。默认情况下，会使用JobParameters来标识JobInstance。但是，spring batch 框架还是允许提交带有不影响JobInstance标识的参数的作业。</p></blockquote><h4 id="1-3、JobExecution-作业执行"><a href="#1-3、JobExecution-作业执行" class="headerlink" title="1.3、JobExecution 作业执行"></a>1.3、JobExecution 作业执行</h4><p>JobExecution 作业执行是指一次尝试运行作业的技术概念。执行的最终结果可能是失败，也可能是成功，但与给定执行相对应的JobInstance不会被视为完成，除非作业执行成功完成。</p><p>以前面描述的EndOfDay作业为例，考虑01-01-2017的JobInstance在第一次运行时失败。如果使用与第一次运行（01-01-2017）相同的标识作业参数再次运行，则会创建一个新的JobExecution。但是，仍然只有一个JobInstance。</p><p>Job定义了什么是作业及其执行方式，执行模板。</p><p>JobInstance是一个纯粹的组织对象，用于将执行分组在一起，主要是为了实现正确的重启语义。</p><p>JobExecution是运行期间实际发生情况的主要存储机制，它包含许多必须控制和持久化的属性。</p><p>JobExecution 的重要属性</p><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>Status</td><td>BatchStatus对象，指示执行的状态。在运行时，它是 BatchStatus#STARTED。如果失败，则为BatchStatus#FAILED。如果成功完成，那就是BatchStatus#COMPLETED</td></tr><tr><td>startTime</td><td>一个java.util.Date代表当执行开始时的当前系统时间。如果作业尚未开始，则此字段为空。</td></tr><tr><td>endTime</td><td>一个java.util.Date代表当执行完成后，无论它是否是成功的当前系统时间。如果作业尚未完成，则该字段为空。</td></tr><tr><td>exitStatus</td><td>ExitStatus，说明运行的结果。这是最重要的，因为它包含返回给调用方的退出代码。 如果作业尚未完成，则该字段为空。</td></tr><tr><td>createTime</td><td>java.util.Date表示当当前系统时间JobExecution最早持续。作业可能尚未启动（因此没有启动时间），但是它始终具有createTime，这是管理作业级别的框架所需的 ExecutionContexts。</td></tr><tr><td>lastUpdated</td><td>java.util.Date 代表上一次JobExecution持续存在的时间。如果作业尚未开始，则此字段为空。</td></tr><tr><td>executionContext</td><td>执行上下文 包含在两次执行之间需要保留的所有用户数据。</td></tr><tr><td>failureExceptions</td><td>执行Job。时遇到的异常列表。如果在失败时遇到多个异常，这些功能将非常有用Job。</td></tr></tbody></table><h3 id="2、Step-作业组件"><a href="#2、Step-作业组件" class="headerlink" title="2、Step 作业组件"></a>2、Step 作业组件</h3><p>Step 即作业执行步骤。Step是一个域对象，每一个Step对象都封装了批处理作业的一个独立的或者连续的阶段。因此，每个Job都由一个或多个Step步骤组成。Step步骤包含定义和控制实际批处理所需的所有信息。与Job作业一样，Step步骤具有单独的StepExecution，与唯一的JobExecution相关。</p><blockquote><p>任何特定的内容Step都是由编写Job的开发人员自行决定。 一个step可以非常简单也可以非常复杂。 例如，一个step的功能是将文件中的数据加载到数据库中，那么基于现在spring batch的支持则几乎不需要写代码。 更复杂的step可能具有复杂的业务逻辑，这些逻辑作为Step处理的一部分。</p></blockquote><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/jobHeirarchyWithSteps.png" alt=""></p><h4 id="2-1、StepExecution"><a href="#2-1、StepExecution" class="headerlink" title="2.1、StepExecution"></a>2.1、StepExecution</h4><p>StepExecution表示一次执行Step的尝试, 每次运行一个Step时都会创建一个新的StepExecution，类似于JobExecution。 但是，某个步骤可能由于其之前的步骤失败而无法执行。 只有在Step实际启动时才会创建StepExecution。</p><p>一次step执行的实例由StepExecution类的对象表示。 每个StepExecution都包含对其相应步骤的引用以及JobExecution和事务相关的数据，例如提交和回滚计数以及开始和结束时间。 此外，每个步骤执行都包含一个ExecutionContext，其中包含开发人员需要在批处理运行中保留的任何数据，例如重新启动所需的统计信息或状态信息。</p><p>StepExecution 的重要属性</p><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>Status</td><td>BatchStatus对象，指示执行的状态。在运行时，状态为BatchStatus.STARTED。如果失败，则状态为BatchStatus.FAILED。如果成功完成，则状态为BatchStatus.COMPLETED。</td></tr><tr><td>startTime</td><td>一个java.util.Date代表当执行开始时的当前系统时间。如果步骤尚未开始，则此字段为空。</td></tr><tr><td>endTime</td><td>一个java.util.Date代表当执行完成后，无论它是否是成功的当前系统时间。如果步骤尚未退出，则此字段为空。</td></tr><tr><td>exitStatus</td><td>ExitStatus指示执行的结果。这是最重要的，因为它包含返回给调用方的退出代码。如果作业尚未退出，则此字段为空。</td></tr><tr><td>executionContext</td><td>执行上下文 包含在两次执行之间需要保留的所有用户数据。</td></tr><tr><td>readCount</td><td>已成功读取的条目数。</td></tr><tr><td>writeCount</td><td>已成功写入的条目数。</td></tr><tr><td>commitCount</td><td>为此执行已提交的事务数</td></tr><tr><td>rollbackCount</td><td>由Step所控制的业务交易已回滚的次数。</td></tr><tr><td>readSkipCount</td><td>read失败次数导致条目被跳过。</td></tr><tr><td>processSkipCount</td><td>process失败次数导致条目被跳过。</td></tr><tr><td>filterCount</td><td>已被ItemProcessor”过滤”的条目数。</td></tr><tr><td>writeSkipCount</td><td>write失败次数导致条目被跳过。</td></tr></tbody></table><h3 id="3、ExecutionContext-执行上下文"><a href="#3、ExecutionContext-执行上下文" class="headerlink" title="3、ExecutionContext 执行上下文"></a>3、ExecutionContext 执行上下文</h3><p>ExecutionContext表示键-值对的集合，这些键-值对由框架进行持久化和控制，以便允许开发人员在一个地方存储持久状态，该持久状态的范围仅限于StepExecution对象或JobExecution对象。</p><p>官方说这个东东和 Quartz 的 JobDataMap 非常相似。</p><p>扯一堆术语，说白了就是有个可以用来存放执行过程中的记录数据、环境数据的Map集合，而这个Map集合会在你每次提交数据的时候，包存在数据库<code>BATCH_STEP_EXECUTION_CONTEXT</code> 表里面。万一执行出错或者中断，下次启动执行的时候还可以接着用。</p><p>最佳用法示例是促进重新启动。以将文件内容加载到数据库为例，在处理各个行时，框架会定期在提交点持久保存ExecutionContext。这样做可以让ItemReader存储其状态，以防在运行过程中发生致命错误，甚至断电。 需要做的就是将当前读取的行数放入上下文中：</p><p>比如在某个step中，记录下当前读取的行数。</p><pre class="language-java"><code class="language-java">ExecutionContext ecStep <span class="token operator">=</span> stepExecution<span class="token punctuation">.</span><span class="token function">getExecutionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ecStep<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span><span class="token function">getKey</span><span class="token punctuation">(</span>LINES_READ_COUNT<span class="token punctuation">)</span><span class="token punctuation">,</span> reader<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>获取上下文</p><p>可以根据StepExecution对象或JobExecution对象获取对应的执行上下文：</p><pre class="language-java"><code class="language-java">ExecutionContext ecStep <span class="token operator">=</span> stepExecution<span class="token punctuation">.</span><span class="token function">getExecutionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ecStep<span class="token punctuation">.</span><span class="token function">gutLong</span><span class="token punctuation">(</span><span class="token function">getKey</span><span class="token punctuation">(</span>LINES_READ_COUNT<span class="token punctuation">)</span><span class="token punctuation">,</span> reader<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ExecutionContext ecJob <span class="token operator">=</span> jobExecution<span class="token punctuation">.</span><span class="token function">getExecutionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ecJob<span class="token punctuation">.</span><span class="token function">gutLong</span><span class="token punctuation">(</span><span class="token function">getKey</span><span class="token punctuation">(</span>LINES_READ_COUNT<span class="token punctuation">)</span><span class="token punctuation">,</span> reader<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ecStep 和 ecJob 是两个不同的ExecutionContext。范围为step的step执行上下文环境的一个保存在step中的每个提交点，而范围为job的一个上下文保存在每个step中。</p><h3 id="4、JobLauncher-作业启动器"><a href="#4、JobLauncher-作业启动器" class="headerlink" title="4、JobLauncher 作业启动器"></a>4、JobLauncher 作业启动器</h3><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">JobLauncher</span> <span class="token punctuation">{</span>

<span class="token keyword">public</span> JobExecution <span class="token function">run</span><span class="token punctuation">(</span>Job job<span class="token punctuation">,</span> JobParameters jobParameters<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> JobExecutionAlreadyRunningException<span class="token punctuation">,</span> JobRestartException<span class="token punctuation">,</span>
                   JobInstanceAlreadyCompleteException<span class="token punctuation">,</span> JobParametersInvalidException<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>执行Job时指定了JobParameters和对应的Job，并返回对应的JobExecution。</p><h3 id="5、JobRepository-作业仓库"><a href="#5、JobRepository-作业仓库" class="headerlink" title="5、JobRepository 作业仓库"></a>5、JobRepository 作业仓库</h3><p>JobRepository是上述所有构造型的持久性机制。它为JobLauncher，Job和Step实现提供CRUD操作。首次启动Job时，会从存储库中获取JobExecution，并在执行过程中将StepExecution和JobExecution实现传递到存储库中，以实现持久性。</p><p>Java配置当使用<code>@EnableBatchProcessing</code>注解，spring batch 就会自动提供一个 <code>JobRepository</code>作为开箱即用自动配置的组件之一。</p><h3 id="6、ItemReader-条目"><a href="#6、ItemReader-条目" class="headerlink" title="6、ItemReader 条目"></a>6、ItemReader 条目</h3><p>ItemReader是一个读数据的抽象，它的功能是为每一个Step提供数据输入。 当ItemReader以及读完所有数据时，它会返回null来告诉后续操作数据已经读完。Spring Batch为ItemReader提供了非常多的有用的实现类。</p><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/all-itemReader.png" alt=""></p><p>ItemReader支持的读入的数据源也是非常丰富的，包括各种类型的数据库，文件，数据流，消息中间件等等。几乎涵盖了我们的所有场景。</p><h4 id="6-1-内置ItemReader"><a href="#6-1-内置ItemReader" class="headerlink" title="6.1 内置ItemReader"></a>6.1 内置ItemReader</h4><ul><li>JdbcPagingItemReader：jdbc分页从数据库读取数据</li><li>HibernateItemReader：使用Hibernate读取数据库</li><li>JpaPagingItemReader: jpa 分页读</li><li>StaxEventItemReader：从XML文件中读取数据</li><li>FlatFileItemReader：从CVS表格文件中读取数据</li><li>MultiResourceItemReader：从多个文件读取数据</li><li>ListItemReader：从List读取数据</li><li>JsonItemReader：从Josn读取数据</li><li>GsonJsonObjectItemReader：从Josn读取数据</li><li>JasksonJsonObjectItemReader：从Josn读取数据</li><li>MongoItemReader：从MongoDB数据库读取数据</li><li>JmsItemReader：从Jms消息读取数据</li><li>AmqpItemReader：从mq 读取数据</li><li>KafkaItemReader：从Kafka读取数据</li><li>Neo4jItemReader：从图形数据库读取数据</li></ul><p>相关文档：<a href="https://docs.spring.io/spring-batch/docs/4.3.x/reference/html/index-single.html#readersAndWriters" target="_blank" rel="noopener">关于ItemReader的文档</a></p><h4 id="6-2-ItemReader-示例"><a href="#6-2-ItemReader-示例" class="headerlink" title="6.2 ItemReader 示例"></a>6.2 ItemReader 示例</h4><p>简单的读数据库数据示例:</p><pre class="language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
     * 从数据库读取数据
     * @return
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> ItemReader<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> <span class="token function">dataSourceItemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        JdbcPagingItemReader<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcPagingItemReader</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置数据源</span>
        reader<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 每次取多少条记录</span>
        reader<span class="token punctuation">.</span><span class="token function">setFetchSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置每页数据量</span>
        reader<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 指定sql查询语句 select id,name,age,gender from user</span>
        MySqlPagingQueryProvider provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySqlPagingQueryProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        provider<span class="token punctuation">.</span><span class="token function">setSelectClause</span><span class="token punctuation">(</span><span class="token string">"id,name,age,gender"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//设置查询字段</span>
        provider<span class="token punctuation">.</span><span class="token function">setFromClause</span><span class="token punctuation">(</span><span class="token string">"from user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置从哪张表查询</span>

        <span class="token comment" spellcheck="true">// 将读取到的数据转换为UserVO对象</span>
        reader<span class="token punctuation">.</span><span class="token function">setRowMapper</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">,</span> rowNum<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            UserVO data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 读取第一个字段，类型为String</span>
            data<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Order<span class="token operator">></span> sort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sort<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> Order<span class="token punctuation">.</span>ASCENDING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        provider<span class="token punctuation">.</span><span class="token function">setSortKeys</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置排序,通过id 升序</span>

        reader<span class="token punctuation">.</span><span class="token function">setQueryProvider</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 设置namedParameterJdbcTemplate等属性</span>
        reader<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> reader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre><p>也可以定制自己的ItemReader，只要实现 <code>ItemReader&lt;T&gt;</code> 接口即可：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>item<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Nullable<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemReader</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Nullable</span>
    T <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">,</span> UnexpectedInputException<span class="token punctuation">,</span> ParseException<span class="token punctuation">,</span> NonTransientResourceException<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>示例：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>xiaocai<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>itemrw<span class="token punctuation">.</span>reader<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>item<span class="token punctuation">.</span>ItemReader<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 *  自己定义 自己的 ItemReader
 * @author Xiaocai.Zhang
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleDemoItemReader</span> <span class="token keyword">implements</span> <span class="token class-name">ItemReader</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> Iterator<span class="token operator">&lt;</span>String<span class="token operator">></span> iterator<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SimpleDemoItemReader</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token keyword">return</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="7、ItemProcessor-条目处理器"><a href="#7、ItemProcessor-条目处理器" class="headerlink" title="7、ItemProcessor 条目处理器"></a>7、ItemProcessor 条目处理器</h3><p>ItemProcessor是表示条目业务处理的抽象。</p><p>当ItemReader读取一个条目，而ItemWriter写入一个条目时，ItemProcessor提供了一个访问点来转换或应用其他业务处理。</p><h4 id="7-1-内置处理器Processor"><a href="#7-1-内置处理器Processor" class="headerlink" title="7.1 内置处理器Processor"></a>7.1 内置处理器Processor</h4><ul><li><p>FunctionItemProcessor</p></li><li><p>ClassifierCompositeItemProcessor</p></li><li><p>CompositeItemProcessor</p></li><li><p>PassThroughItemProcessor</p></li><li><p>ScriptItemProcessor</p></li><li><p>BeanValidatingItemProcessor</p></li><li><p>ValidatingItemProcessor</p></li></ul><h4 id="7-2-自定义处理器Processor"><a href="#7-2-自定义处理器Processor" class="headerlink" title="7.2 自定义处理器Processor"></a>7.2 自定义处理器Processor</h4><p><strong>实现方式一：完全的自定义。实现 <code>ItemProcessor</code> 接口</strong></p><p>如果在处理项目时确定该条目无效，则返回null表示不应将该项目写出。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>xiaocai<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>itemrw<span class="token punctuation">.</span>validator<span class="token punctuation">;</span>

<span class="token keyword">import</span> cn<span class="token punctuation">.</span>xiaocai<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>VO<span class="token punctuation">.</span>UserVO<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>item<span class="token punctuation">.</span>ItemProcessor<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author Xiaocai.Zhang
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataFilterItemProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">ItemProcessor</span><span class="token operator">&lt;</span>UserVO<span class="token punctuation">,</span> UserVO<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> UserVO <span class="token function">process</span><span class="token punctuation">(</span>UserVO userVO<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 返回null，会过滤掉这条数据,条件是ID为空或者</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span> <span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>userVO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>userVO<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> userVO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p><strong>实现方式二：自定义继承已有内置的<code>ItemProcessor</code>类</strong></p><p>定义一个导入用户数据的处理，要将男女转换成1和2。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>xiaocai<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>itemrw<span class="token punctuation">.</span>processor<span class="token punctuation">;</span>

<span class="token keyword">import</span> cn<span class="token punctuation">.</span>xiaocai<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>VO<span class="token punctuation">.</span>UserVO<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>item<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>ValidatingItemProcessor<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>item<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>ValidationException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author Xiaocai.Zhang
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CsvItemProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">ValidatingItemProcessor</span><span class="token operator">&lt;</span>UserVO<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> UserVO <span class="token function">process</span><span class="token punctuation">(</span>UserVO item<span class="token punctuation">)</span> <span class="token keyword">throws</span> ValidationException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 需执行super.proces:(item)才会调用自定义校验器。</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 对数据做简单的处理，若性别为男，则数据转换成1，其余转换成2.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getGender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"男"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> item<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><h3 id="8、ItemWriter-条目写"><a href="#8、ItemWriter-条目写" class="headerlink" title="8、ItemWriter 条目写"></a>8、ItemWriter 条目写</h3><p>与ItemReader相对应的，ItemWriter就是一个写数据的抽象，它是为每一个step提供数据写出的功能。写的单位是可以配置的，我们可以一次写一条数据，也可以一次写一个chunk的数据。ItemWriter对于读入的数据是不能做任何操作的。</p><p>Spring Batch为ItemWriter也提供了非常多的有用的实现类，当然我们也可以去实现自己的writer功能。</p><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/all-itemWriter.png" alt=""></p><p>跟ItemReader一样，ItemWriter支持的写入入的数据源也是非常丰富的，包括各种类型的数据库，文件，数据流，消息中间件等等。几乎涵盖了我们的所有场景。</p><h4 id="7-1-内置ItemWriter"><a href="#7-1-内置ItemWriter" class="headerlink" title="7.1 内置ItemWriter"></a>7.1 内置ItemWriter</h4><ul><li>SimpleMailMessageItemWriter、MimeMessageItemWriter：写邮件相关</li><li>JdbcBatchItemWriter：jdbc批量写入数据库</li><li>HibernateItemWriter：使用Hibernate写入数据库</li><li>JpaItemWriter: jpa 写入数据库</li><li>StaxEventItemWriter：写入XML文件</li><li>FlatFileItemWriter：写入CVS文件</li><li>MultiResourceItemWriter：写入多个文件</li><li>ListItemWriter：写入List数据</li><li>JsonFileItemWriter：写入Josn文件</li><li>JmsItemWriter：Jms消息写入</li><li>AmqpItemWriter：写入标准应用消息队列</li><li>KafkaItemWriter：写入Kafka数据</li><li>MongoItemWriter：写入MongoDB数据库</li><li>Neo4jItemWriter：写入图形数据库读</li><li>AvroItemWriter：序列化相关读取数据</li></ul><p>相关文档：<a href="https://docs.spring.io/spring-batch/docs/4.3.x/reference/html/index-single.html#readersAndWriters" target="_blank" rel="noopener">关于ItemWriter的文档</a></p><h4 id="7-2-ItemWriter-的示例"><a href="#7-2-ItemWriter-的示例" class="headerlink" title="7.2 ItemWriter 的示例"></a>7.2 ItemWriter 的示例</h4><p>简单的写文件示例：</p><pre class="language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     *  写文件，写成字符串
     * @return
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> FlatFileItemWriter<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> <span class="token function">fileItemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        FlatFileItemWriter<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlatFileItemWriter</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        FileSystemResource file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileSystemResource</span><span class="token punctuation">(</span><span class="token string">"E:/spring-batch/user_info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Path path <span class="token operator">=</span> Paths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Files<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Files<span class="token punctuation">.</span><span class="token function">createFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        writer<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置目标文件路径</span>

        <span class="token comment" spellcheck="true">// 把读到的每个UserVO对象转换为JSON字符串</span>
        LineAggregator<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> aggregator <span class="token operator">=</span> item <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 这里可以自定义拼接规则</span>
                ObjectMapper mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        writer<span class="token punctuation">.</span><span class="token function">setLineAggregator</span><span class="token punctuation">(</span>aggregator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre><h3 id="9、补充"><a href="#9、补充" class="headerlink" title="9、补充"></a>9、补充</h3><h4 id="（1）chunk"><a href="#（1）chunk" class="headerlink" title="（1）chunk"></a>（1）chunk</h4><p>一次batch的任务可能会有很多的数据读写操作，因此一条一条的处理并向数据库提交的话效率不会很高，因此spring batch提供了chunk这个概念，我们可以设定一个chunk size，spring batch 将一条一条梳理处理之后，先不提交到数据库，只有当处理的数据数量达到chunk size设定的值得时候，才一起去commit到数据库。</p><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/step-chunk.png" alt=""></p><h4 id="（2）skip"><a href="#（2）skip" class="headerlink" title="（2）skip"></a>（2）skip</h4><pre class="language-java"><code class="language-java">    <span class="token keyword">private</span> Step <span class="token function">rwStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"step"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span>myJobListener<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>&lt;UserVO<span class="token punctuation">,</span>UserVO<span class="token operator">></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">fileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">processor</span><span class="token punctuation">(</span><span class="token function">processor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">dataSourceItemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">faultTolerant</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">skipLimit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">noSkip</span><span class="token punctuation">(</span>FileNotFoundException<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre><p>skipLimit方法的意思是我们可以设定一个我们允许的这个step可以跳过的异常数量，假如我们设定为10，则当这个step运行时，只要出现的异常数目不超过10，整个step都不会fail。注意，若不设定skipLimit，则其默认值是0.</p><p>skip方法我们可以指定我们可以跳过的异常，因为有些异常的出现，我们是可以忽略的。</p><p>noSkip方法的意思则是指出现这个异常我们不想跳过，也就是从skip的所以exception当中排除这个exception，从上面的例子来说，也就是跳过所有除FileNotFoundException的exception。那么对于这个step来说，FileNotFoundException就是一个fatal的exception，抛出这个exception的时候step就会直接fail</p><h2 id="三、重要API"><a href="#三、重要API" class="headerlink" title="三、重要API"></a>三、重要API</h2><h4 id="1、数据上下文"><a href="#1、数据上下文" class="headerlink" title="1、数据上下文"></a>1、数据上下文</h4><ul><li><p>ExecutionContext 执行上下文。 本质是个Map，可以持久化到数据库，持久状态的范围仅限于StepExecution对象或JobExecution对象。</p></li><li><p>JobContext：可以获取 JobExecution、存取用户临时数据、 Job实例、Job执行实例、退出状态、批量处理状态、异常等。</p></li><li><p>JobExecution：可以通过 JobContext 获取。可以获取 JobExecutionContext 作业执行上下文对象 和 JobParameters 作业参数对象。</p></li><li><p>StepContext：可以获取 StepExecution、存取用户临时数据、 持久化用户数据、步骤执行实例、退出状态、批量处理状态、异常等。</p></li><li><p>StepExecution：可以通过 StepContext 获取。可以获取 JobExecution 作业执行对象、StepExecutionContext 作业执行上下文对象。</p></li><li><p>ChunkContext： 可以获取 StepContext上下文。</p></li></ul><h3 id="2、监听器"><a href="#2、监听器" class="headerlink" title="2、监听器"></a>2、监听器</h3><ul><li><p>JobExecutionListener 作业执行监听器。实现方式2种：</p><ul><li>实现 JobExecutionListener 接口，重写<code>beforeJob()</code> 和 <code>afterJob()</code> 方法。</li><li>使用<code>@BeforeJob</code> 和 <code>@AfterJob</code> 修饰对应的方法。</li></ul></li><li><p>StepExecutionListener 步骤执行监听器。实现方式2种：</p><ul><li>实现 StepExecutionListener 接口，重写<code>beforeStep()</code> 和 <code>afterStep()</code> 方法。</li><li>使用<code>@BeforeStep</code> 和 <code>@AfterStep</code> 修饰对应的方法。</li></ul></li><li><p>ItemReadListener 读数据项监听器。实现方式2种：</p><ul><li>实现 ItemReadListener 接口，重写<code>beforeRead()</code> 和 <code>afterRead()</code> 以及 <code>onReadError()</code> 方法。</li><li>使用<code>@BeforeRead</code>、 <code>@AfterRead</code>、<code>@OnReadError</code> 修饰对应的方法。</li></ul></li></ul><ul><li>ItemWriteListener 写数据项监听器。实现方式2种：<ul><li>实现 ItemWriteListener 接口，重写<code>beforeWrite()</code> 和 <code>afterWrite()</code> 以及 <code>onWriteError()</code> 方法。</li><li>使用<code>@BeforeWrite</code>、 <code>@AfterWrite</code>、<code>@OnWriteError</code> 修饰对应的方法。</li></ul></li></ul><ul><li><p>ItemProcessListener 处理数据项监听器。实现方式2种：</p><ul><li>实现 ItemProcessListener 接口，重写<code>beforeProcess()</code> 和 <code>afterProcess()</code>以及 <code>onProcessError()</code> 方法。</li><li>使用<code>@BeforeProcess</code>、 <code>@AfterProcess</code>、<code>@OnProcessError</code> 修饰对应的方法。</li></ul></li><li><p>ChunkListener 处理数据块项监听器。实现方式2种：</p><ul><li>实现 ChunkListener 接口，重写<code>beforeChunk()</code> 和 <code>afterChunk()</code>以及 <code>AfterChunkError()</code> 方法。</li><li>使用<code>@BeforeChunk</code>、 <code>@AfterChunk</code>、<code>@AfterChunkError</code> 修饰对应的方法。</li></ul></li><li><p>SkipListener 跳过数据的监听器。实现方式2种：</p><ul><li>实现 SkipListener 接口，重写<code>onSkipInRead()</code> 和 <code>onSkipInWrite()</code>以及 <code>onSkipInProcess()</code> 方法。</li><li>使用<code>@OnSkipInRead</code>、 <code>@OnSkipInWrite</code>、<code>@OnSkipInProcess</code> 修饰对应的方法。</li></ul></li></ul><p>实例：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>xiaocai<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>listener<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>BatchStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>JobExecution<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>JobExecutionListener<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>JobParameters<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>BeforeJob<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>scope<span class="token punctuation">.</span>context<span class="token punctuation">.</span>JobContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>scope<span class="token punctuation">.</span>context<span class="token punctuation">.</span>StepContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Duration<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>LocalDateTime<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 自定义 Job作业执行 的监听器
 * @author Xiaocai.Zhang
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJobExecutionListener</span> <span class="token keyword">implements</span> <span class="token class-name">JobExecutionListener</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> LocalDateTime startTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> LocalDateTime endTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> JobContext jobContext<span class="token punctuation">;</span>
    StepContext stepContext<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeJob</span><span class="token punctuation">(</span>JobExecution jobExecution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        startTime <span class="token operator">=</span> LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"start time {}"</span><span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        JobParameters jobParameters <span class="token operator">=</span> jobExecution<span class="token punctuation">.</span><span class="token function">getJobParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"jobParameters {}"</span><span class="token punctuation">,</span> jobParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterJob</span><span class="token punctuation">(</span>JobExecution jobExecution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        endTime <span class="token operator">=</span> LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"start time {}"</span><span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"elapsed time: {} s"</span><span class="token punctuation">,</span> Duration<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>BatchStatus<span class="token punctuation">.</span>COMPLETED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jobExecution<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//job success</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"job success !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>BatchStatus<span class="token punctuation">.</span>FAILED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jobExecution<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//job failure</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"job failure !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><h2 id="四、使用案例"><a href="#四、使用案例" class="headerlink" title="四、使用案例"></a>四、使用案例</h2><h3 id="1、引入依赖"><a href="#1、引入依赖" class="headerlink" title="1、引入依赖"></a>1、引入依赖</h3><pre class="language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-batch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h3 id="2、添加配置"><a href="#2、添加配置" class="headerlink" title="2、添加配置"></a>2、添加配置</h3><pre class="language-yml"><code class="language-yml">spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/springboot_batch?serverTimezone=GMT%2b8&useSSL=true&Unicode=true&characterEncoding=utf8&autoReconnectForPools=true&allowMultiQueries=true&rewriteBatchedStatements=true
    username: root
    password: 123456


# 默认是启动时执行一次，设置为false，表示启动不执行，可以通过 web等其他请求调用方式执行
  batch:
    job:
      enabled: false  #是否自动执行定义的Job，默认是
      names:  # 启动是要执行的job
    initialize-schema: never # 是否初始化Spring Batch的数据库，ALWAYS,EMBEDDED,NEVER
    schema:   # 默认有对应的sql脚本，建议手工执行脚本
    table-prefix: TASK_  # 设置Spring Batch的数据库表的前缀,默认是TASK_</code></pre><h3 id="3、数据库准备"><a href="#3、数据库准备" class="headerlink" title="3、数据库准备"></a>3、数据库准备</h3><p>这里使用的是MySQL脚本。其他脚本请到spring-batch-core 包找一下就有。</p><p>我的工程里也有，路径在：<code>resource/sql/batch_init.sql</code></p><p>Schema是 <code>springboot_batch</code>，添加待会要导入的 uer表</p><pre class="language-SQL"><code class="language-SQL">CREATE TABLE USER (
    ID BIGINT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    NAME VARCHAR(10) NOT NULL,
    AGE SMALLINT NULL,
    GENDER CHAR(1)
) ENGINE=InnoDB;
</code></pre><h3 id="4、读写示例"><a href="#4、读写示例" class="headerlink" title="4、读写示例"></a>4、读写示例</h3><p>比如完整将文件数据导入数据库的示例：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>xiaocai<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>itemrw<span class="token punctuation">.</span>job<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 一个完整读写的例子，导入省略
 * @author Xiaocai.Zhang
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemRwJobDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> JobBuilderFactory jobBuilderFactory<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> StepBuilderFactory stepBuilderFactory<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> CsvItemProcessor csvBeanValidator<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> MyJobListener myJobListener<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> DataSource dataSource<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     *  以Bean的形式放入ioc，工程启动就会执行，仅demo使用
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> Job <span class="token function">rwDemoJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>

        <span class="token keyword">return</span> jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"rwDemoJob"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">rwStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     *  这里是把读写处理都放一个步骤
     * @return
     */</span>
    <span class="token keyword">private</span> Step <span class="token function">rwStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"step"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span>myJobListener<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>&lt;UserVO<span class="token punctuation">,</span>UserVO<span class="token operator">></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">fileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">processor</span><span class="token punctuation">(</span><span class="token function">processor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">dataSourceItemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 读取数据
     * @return
     */</span>
    <span class="token keyword">public</span> ItemReader<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> <span class="token function">fileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 使用FlatFileItemReader去读cvs文件，一行即一条数据</span>
        FlatFileItemReader<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlatFileItemReader</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置文件处在路径</span>
        reader<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"user.csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// entity与csv数据做映射</span>
        reader<span class="token punctuation">.</span><span class="token function">setLineMapper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultLineMapper</span><span class="token operator">&lt;</span>UserVO<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">{</span>
                <span class="token function">setLineTokenizer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DelimitedLineTokenizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 列映射</span>
                        <span class="token function">setNames</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"gender"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setFieldSetMapper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanWrapperFieldSetMapper</span><span class="token operator">&lt;</span>UserVO<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">setTargetType</span><span class="token punctuation">(</span>UserVO<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> reader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     *  处理过程
     * @return
     */</span>
    <span class="token keyword">private</span> ItemProcessor<span class="token operator">&lt;</span>UserVO<span class="token punctuation">,</span> UserVO<span class="token operator">></span> <span class="token function">processor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        CsvItemProcessor processor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CsvItemProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        processor<span class="token punctuation">.</span><span class="token function">setValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Validator<span class="token operator">&lt;</span>UserVO<span class="token operator">></span><span class="token punctuation">)</span> csvBeanValidator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> processor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 写入数据库,需要自己建表
     * @return
     */</span>
    <span class="token keyword">private</span> ItemWriter<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> <span class="token function">dataSourceItemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 写入数据库</span>
        JdbcBatchItemWriter<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcBatchItemWriter</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置写入的数据源</span>
        writer<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

        String sql <span class="token operator">=</span> <span class="token string">"insert into USER(id,name,age,gender) values (:id,:name,:age,:gender)"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置插入sql脚本</span>
        writer<span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 映射UserVO对象属性到占位符中的属性</span>
        BeanPropertyItemSqlParameterSourceProvider<span class="token operator">&lt;</span>UserVO<span class="token operator">></span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanPropertyItemSqlParameterSourceProvider</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">setItemSqlParameterSourceProvider</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>

        writer<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置一些额外属性</span>
        <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span></code></pre><p>诸多示例，不再一一列举，找示例可以参考我的工程代码。</p><h3 id="5、案例代码"><a href="#5、案例代码" class="headerlink" title="5、案例代码"></a>5、案例代码</h3><h4 id="1、Demo-code"><a href="#1、Demo-code" class="headerlink" title="1、Demo code"></a>1、Demo code</h4><p>工程地址：<a href="https://github.com/small-rose/springboot-batch-demo" target="_blank" rel="noopener">spring-batch-demo</a></p><h4 id="2、工程代码保函示例："><a href="#2、工程代码保函示例：" class="headerlink" title="2、工程代码保函示例："></a>2、工程代码保函示例：</h4><h4 id="2-1-ItemReader-相关示例"><a href="#2-1-ItemReader-相关示例" class="headerlink" title="2.1 ItemReader 相关示例"></a>2.1 ItemReader 相关示例</h4><ul><li>读数据库数据的Job示例</li><li>读文件数据的Job示例</li><li>读多个文件数据的Job示例</li><li>读XML文件数据的Job示例</li><li>读Json文件数据的Job示例</li><li>按自定义规则读取数据的Job示例</li></ul><h4 id="2-2-Processor-处理器相关示例"><a href="#2-2-Processor-处理器相关示例" class="headerlink" title="2.2 Processor 处理器相关示例"></a>2.2 Processor 处理器相关示例</h4><ul><li>现接口方式自定义数据过滤的Processor</li><li>继承的方式实现自定义的Processor</li></ul><h4 id="2-3-ItemWriter-相关示例"><a href="#2-3-ItemWriter-相关示例" class="headerlink" title="2.3 ItemWriter 相关示例"></a>2.3 ItemWriter 相关示例</h4><ul><li>写入数据到数据库的Job示例</li><li>写入数据到文件的Job示例</li><li>写入数据到Json文件的Job示例</li><li>写入数据到多个文件的Job示例</li><li>写入数据到XML文件的Job示例</li></ul><h4 id="2-4-Job-相关示例"><a href="#2-4-Job-相关示例" class="headerlink" title="2.4 Job 相关示例"></a>2.4 Job 相关示例</h4><ul><li>单个Step的Job示例</li><li>多个Step的Job示例</li><li>带状态判断的多个Step的Job示例</li><li>带决策器的Job示例</li><li>带监听器的Job示例</li><li>使用Flow组装Step的Job示例</li><li>并行执行Job使用的Job示例</li><li>嵌套执行Job使用的Job示例</li><li>配合Scheduled调度器启动Job的示例</li><li>Restful接口调用启动Job的示例</li></ul><h2 id="五、XML-版配置"><a href="#五、XML-版配置" class="headerlink" title="五、XML 版配置"></a>五、XML 版配置</h2><p>尽管现在基本上都是面向注解开发，XML配置用的少了，但是保不齐会有一些老项目使用，学习了解一下也是不错的。</p><h3 id="1、命名空间支持"><a href="#1、命名空间支持" class="headerlink" title="1、命名空间支持"></a>1、命名空间支持</h3><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/batch<span class="token punctuation">"</span></span>
<span class="token attr-name"><span class="token namespace">xmlns:</span>beans</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
<span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>
   http://www.springframework.org/schema/beans
   https://www.springframework.org/schema/beans/spring-beans.xsd
   http://www.springframework.org/schema/batch
   https://www.springframework.org/schema/batch/spring-batch.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token comment" spellcheck="true">&lt;!-- 配置 jobRepository--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job-repository</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ioSampleJob<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>step1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tasklet</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>chunk</span> <span class="token attr-name">reader</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>itemReader<span class="token punctuation">"</span></span> <span class="token attr-name">writer</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>itemWriter<span class="token punctuation">"</span></span> <span class="token attr-name">commit-interval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tasklet</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>step</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">beans:</span>beans</span><span class="token punctuation">></span></span></code></pre><p>命名空间下面就不再全部粘贴了。</p><h3 id="2、配置Job"><a href="#2、配置Job" class="headerlink" title="2、配置Job"></a>2、配置Job</h3><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>footballJob<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerload<span class="token punctuation">"</span></span>          <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s1<span class="token punctuation">"</span></span> <span class="token attr-name">next</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gameLoad<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gameLoad<span class="token punctuation">"</span></span>            <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s2<span class="token punctuation">"</span></span> <span class="token attr-name">next</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerSummarization<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerSummarization<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s3<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span></code></pre><p>等价于</p><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> Job <span class="token function">footballJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"footballJob"</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">playerLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">gameLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">playerSummarization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><h4 id="2-1-可重启配置"><a href="#2-1-可重启配置" class="headerlink" title="2.1 可重启配置"></a>2.1 可重启配置</h4><p>如果当一个job不能被restart的时候,只需要将 restartable 属性设置成 ‘false’.一个job instance和job parameter相关，每次在启动job时传入的参数的值相同，可以认为同一个job instance. 我们可以将运行job的当前时间作为一个参数传入,这样子每次启动都是不同的job instance.</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>footballJob<span class="token punctuation">"</span></span> <span class="token attr-name">restartable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerload<span class="token punctuation">"</span></span>          <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s1<span class="token punctuation">"</span></span> <span class="token attr-name">next</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gameLoad<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gameLoad<span class="token punctuation">"</span></span>            <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s2<span class="token punctuation">"</span></span> <span class="token attr-name">next</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerSummarization<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerSummarization<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s3<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span></code></pre><h4 id="2-2-配置监听器"><a href="#2-2-配置监听器" class="headerlink" title="2.2 配置监听器"></a>2.2 配置监听器</h4><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>footballJob<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerload<span class="token punctuation">"</span></span>          <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s1<span class="token punctuation">"</span></span> <span class="token attr-name">next</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gameLoad<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gameLoad<span class="token punctuation">"</span></span>            <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s2<span class="token punctuation">"</span></span> <span class="token attr-name">next</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerSummarization<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playerSummarization<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>s3<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listeners</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sampleListener<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listeners</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span></code></pre><p>注意的afterJob是，无论方法是成功还是失败，都将调用该方法Job。如果需要确定成功或失败，则可以从中获取JobExecution判断：</p><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterJob</span><span class="token punctuation">(</span>JobExecution jobExecution<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jobExecution<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BatchStatus<span class="token punctuation">.</span>COMPLETED <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//job success</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>jobExecution<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BatchStatus<span class="token punctuation">.</span>FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//job failure</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><h4 id="2-3-继承Job"><a href="#2-3-继承Job" class="headerlink" title="2.3 继承Job"></a>2.3 继承Job</h4><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>baseJob<span class="token punctuation">"</span></span> <span class="token attr-name">abstract</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listeners</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>listenerOne<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listeners</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>job1<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>baseJob<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>step1<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>standaloneStep<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listeners</span> <span class="token attr-name">merge</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>listenerTwo<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listeners</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span></code></pre><p>此时的 job1 就有两个监听器了。</p><p>在XML名称空间中声明的作业或使用的任何子类 <code>AbstractJob</code>可以在运行时声明作业参数的验证器。例如，当需要断言一个作业使用其所有必填参数启动时，此功能很有用。有一个 <code>DefaultJobParametersValidator</code>可用于约束简单的强制性和可选参数的组合，对于更复杂的约束，需要自己实现接口。</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>job1<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>baseJob3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>step1<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>standaloneStep<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>validator</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parametersValidator<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span></code></pre><h3 id="3、JobRepostory"><a href="#3、JobRepostory" class="headerlink" title="3、JobRepostory"></a>3、JobRepostory</h3><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job-repository</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span>
    <span class="token attr-name">data-source</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span>
    <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span>
    <span class="token attr-name">isolation-level-for-create</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SERIALIZABLE<span class="token punctuation">"</span></span>
    <span class="token attr-name">table-prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>BATCH_<span class="token punctuation">"</span></span>
    <span class="token attr-name">max-varchar-length</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre><p>配置中，除了ID，其他的如果未设置，将使用上面显示的默认值。<code>max-varchar-length</code> 的默认值是2500。</p><h4 id="3-1、JobRepostory事务配置"><a href="#3-1、JobRepostory事务配置" class="headerlink" title="3.1、JobRepostory事务配置"></a>3.1、JobRepostory事务配置</h4><p>如果使用名称空间或提供的名称空间FactoryBean，则会在JobRepostory操作时自动创建事务建议。</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job-repository</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span> <span class="token attr-name">isolation-level-for-create</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REPEATABLE_READ<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
``                

使用aop的方式配置事物：

​```xml
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span>
           <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>execution(* org.springframework.batch.core..*Repository+.*(..))<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    &lt;advice-ref = "txAdvice" />
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>txAdvice<span class="token punctuation">"</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>*<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">></span></span></code></pre><h4 id="3-2、改表前缀"><a href="#3-2、改表前缀" class="headerlink" title="3.2、改表前缀"></a>3.2、改表前缀</h4><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job-repository</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span>   <span class="token attr-name">table-prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SYSTEM.TEST_<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre><h4 id="3-3、内存数据库"><a href="#3-3、内存数据库" class="headerlink" title="3.3、内存数据库"></a>3.3、内存数据库</h4><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.batch.core.repository.support.MapJobRepositoryFactoryBean<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span></code></pre><p>新的版本已经废弃了。</p><h3 id="4、JobLauncher"><a href="#4、JobLauncher" class="headerlink" title="4、JobLauncher"></a>4、JobLauncher</h3><h4 id="4-1、同步作业"><a href="#4-1、同步作业" class="headerlink" title="4.1、同步作业"></a>4.1、同步作业</h4><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/job-launcher-sequence-sync.png" alt="JobLauncher 同步作业"></p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobLauncher<span class="token punctuation">"</span></span>
      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.batch.core.launch.support.SimpleJobLauncher<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span></code></pre><h4 id="4-2、异步作业"><a href="#4-2、异步作业" class="headerlink" title="4.2、异步作业"></a>4.2、异步作业</h4><p><img src="/medias/loading-animated.gif" data-original="/images/spring-batch/job-launcher-sequence-async.png" alt="JobLauncher 异步作业"></p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobLauncher<span class="token punctuation">"</span></span>
      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.batch.core.launch.support.SimpleJobLauncher<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jobRepository<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>taskExecutor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.core.task.SimpleAsyncTaskExecutor<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span></code></pre><p>spring 的<code>TaskExecutor</code> 接口的任何实现都可以用来控制如何异步执行作业。</p><p>东西还说非常多的，直接留个API吧：<a href="https://docs.spring.io/spring-batch/docs/4.3.x/reference/html/index-single.html#xmlReadingWriting" target="_blank" rel="noopener">spring-batch-XML</a></p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">Small-Rose / 张小菜</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://small-rose.github.io/posts/7e9b1e27.html">https://small-rose.github.io/posts/7e9b1e27.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">Small-Rose / 张小菜</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/Spring-batch/"><span class="chip bg-color">Spring batch</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22AB38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019FE8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/gitalk/gitalk.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/css/my-gitalk.css"><div class="card gitalk-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="gitalk-container" class="card-content"></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/gitalk/gitalk.min.js"></script><script>let gitalk = new Gitalk({
        clientID: '25d0a50a89b8a9328515',
        clientSecret: '87ad6a6e64a7b5727d9c9f5f049f5a28bf714dcc',
        repo: 'small-rose.github.io',
        owner: 'small-rose',
        admin: "small-rose",
        id: '2020-12-12T10-00-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/8f5c11d2.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/featureimages/17.jpg" class="responsive-img" alt="静态博客-字体更换"> <span class="card-title">静态博客-字体更换</span></div></a><div class="card-content article-content"><div class="summary block-with-text">记录网站字体更换过程。</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-12-12 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Hexo/" class="post-category">Hexo</a></span></div></div><div class="card-action article-tags"><a href="/tags/Hexo/"><span class="chip bg-color">Hexo</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/ab810780.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/featureimages/21.jpg" class="responsive-img" alt="基于SpringBoot的自定义注解"> <span class="card-title">基于SpringBoot的自定义注解</span></div></a><div class="card-content article-content"><div class="summary block-with-text">基于SpringBoot的自定义注解。</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-12-06 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/SpringBoot/" class="post-category">SpringBoot</a></span></div></div><div class="card-action article-tags"><a href="/tags/Annotation/"><span class="chip bg-color">Annotation</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){if("undefined"!=typeof window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("120"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>");var i=document.location.href;o.innerHTML+='<br />来源: 张小菜苔<br />文章作者: Small Rose / 张小菜<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)}}})</script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{display:none;font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{display:none;font-size:15px;color:#42b983}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="netease" type="playlist" id="503838841" fixed="true" autoplay theme="#42b983" loop order="random" preload="auto" volume="0.7" list-folded="true"></meting-js></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2020</span> <a href="/about" target="_blank">Small Rose / 张小菜</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">400.9k</span>&nbsp;字 <span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><span id="sitetime">载入运行时间...</span><script>function siteTime(){var e=1e3,t=60*e,n=60*t,o=24*n,r=365*o,a=new Date,i="2020",l="5",m="1",M="0",g="0",d="0",s=a.getFullYear(),u=a.getMonth()+1,T=a.getDate(),c=a.getHours(),f=a.getMinutes(),h=a.getSeconds(),y=Date.UTC(i,l,m,M,g,d),H=Date.UTC(s,u,T,c,f,h),I=H-y,B=Math.floor(I/r),D=Math.floor(I/o-365*B),E=Math.floor((I-(365*B+D)*o)/n),L=Math.floor((I-(365*B+D)*o-E*n)/t),v=Math.floor((I-(365*B+D)*o-E*n-L*t)/e);i==s?(document.getElementById("year").innerHTML=s,document.getElementById("sitetime").innerHTML="本站已安全运行 "+D+" 天 "+E+" 小时 "+L+" 分钟 "+v+" 秒"):(document.getElementById("year").innerHTML=i+" - "+s,document.getElementById("sitetime").innerHTML="本站已安全运行 "+B+" 年 "+D+" 天 "+E+" 小时 "+L+" 分钟 "+v+" 秒")}setInterval(siteTime,1e3)</script><br><span id="icp"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/medias/icp.png" style="vertical-align:text-bottom"> <a href="http://beian.miit.gov.cn/" target="_blank">鄂ICP备19015637号</a></span></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/small-rose" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:small-rose@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=970175021" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 970175021" data-position="top" data-delay="50"><i class="fab fa-qq"></i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/search.js"></script><script type="text/javascript">$(function(){searchFunc("https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/materialize/materialize.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/masonry/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/aos/aos.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/scrollprogress/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/matery.js"></script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/others/clicklove.js" async></script><script async src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/others/busuanzi.pure.mini.js"></script><script type="text/javascript" size="150" alpha="0.6" zindex="-1" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/background/ribbon-refresh.min.js" async></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/libs/instantpage/instantpage.js" type="module"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/funnyTitle.js" type="module"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/sakura.js" type="module"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io@master/js/fullscreen.js" type="module"></script><script>window.imageLazyLoadSetting={isSPA:!1,processImages:null}</script><script>window.addEventListener("load",function(){var a=/\.(gif|jpg|jpeg|tiff|png)$/i,e=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(t){var r=t.parentNode;"A"===r.tagName&&(r.href.match(a)||r.href.match(e))&&(r.href=t.dataset.original)})})</script><script>!function(t){function e(){n&&(i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var e,o,a=0;a<i.length;a++)e=i[a],0<=(o=e.getBoundingClientRect()).bottom&&0<=o.left&&o.top<=(t.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,o,r=i[a];t=r,e=function(){i=i.filter(function(t){return r!==t})},n=new Image,o=t.getAttribute("data-original"),n.onload=function(){t.src=o,e&&e()},n.src=o}()}t.imageLazyLoadSetting.processImages=e;var n=t.imageLazyLoadSetting.isSPA,i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));e(),t.addEventListener("scroll",function(){var n,i;n=e,i=t,clearTimeout(n.tId),n.tId=setTimeout(function(){n.call(i)},500)})}(this)</script></body></html><!-- rebuild by neat -->