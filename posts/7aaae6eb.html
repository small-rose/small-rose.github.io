<!-- build time:Sat Jan 02 2021 15:13:05 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="keywords" content="java,Tomcat,Servlet"><meta name="description" content="Small-Rose,张小菜苔,个人技术笔记,记录学习/开发问题"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>Tomcat 执行流程 | 斯莫笔记</title><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/lightGallery/css/lightgallery.min.css"><script type="text/javascript" src="/libs/artitalk/artitalk.min.css"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/css/matery.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/css/my.css"><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="斯莫笔记" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><style type="text/css" lang="css">#loading-container{position:fixed;top:0;left:0;min-height:100vh;width:100vw;z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#FFF;background-color:#cce8cf;text-align:center;-webkit-transition:opacity 1s ease;-moz-transition:opacity 1s ease;-o-transition:opacity 1s ease;transition:opacity 1s ease}.loading-image{width:120px;height:50px;transform:translate(-50%)}.loading-image div:nth-child(2){-webkit-animation:pacman-balls 1s linear 0s infinite;animation:pacman-balls 1s linear 0s infinite}.loading-image div:nth-child(3){-webkit-animation:pacman-balls 1s linear .33s infinite;animation:pacman-balls 1s linear .33s infinite}.loading-image div:nth-child(4){-webkit-animation:pacman-balls 1s linear .66s infinite;animation:pacman-balls 1s linear .66s infinite}.loading-image div:nth-child(5){-webkit-animation:pacman-balls 1s linear .99s infinite;animation:pacman-balls 1s linear .99s infinite}.loading-image div:first-of-type{width:0;height:0;border:25px solid #49b1f5;border-right-color:transparent;border-radius:25px;-webkit-animation:rotate_pacman_half_up .5s 0s infinite;animation:rotate_pacman_half_up .5s 0s infinite}.loading-image div:nth-child(2){width:0;height:0;border:25px solid #49b1f5;border-right-color:transparent;border-radius:25px;-webkit-animation:rotate_pacman_half_down .5s 0s infinite;animation:rotate_pacman_half_down .5s 0s infinite;margin-top:-50px}@-webkit-keyframes rotate_pacman_half_up{0%{transform:rotate(270deg)}50%{transform:rotate(1turn)}to{transform:rotate(270deg)}}@keyframes rotate_pacman_half_up{0%{transform:rotate(270deg)}50%{transform:rotate(1turn)}to{transform:rotate(270deg)}}@-webkit-keyframes rotate_pacman_half_down{0%{transform:rotate(90deg)}50%{transform:rotate(0)}to{transform:rotate(90deg)}}@keyframes rotate_pacman_half_down{0%{transform:rotate(90deg)}50%{transform:rotate(0)}to{transform:rotate(90deg)}}@-webkit-keyframes pacman-balls{75%{opacity:.7}to{transform:translate(-100px,-6.25px)}}@keyframes pacman-balls{75%{opacity:.7}to{transform:translate(-100px,-6.25px)}}.loading-image div:nth-child(3),.loading-image div:nth-child(4),.loading-image div:nth-child(5),.loading-image div:nth-child(6){background-color:#49b1f5;width:15px;height:15px;border-radius:100%;margin:2px;width:10px;height:10px;position:absolute;transform:translateY(-6.25px);top:25px;left:100px}.loading-text{margin-bottom:20vh;text-align:center;color:#2c3e50;font-size:2rem;box-sizing:border-box;padding:0 10px;text-shadow:0 2px 10px rgba(0,0,0,.2)}@media only screen and (max-width:500px){.loading-text{font-size:1.5rem}}.fadeout{opacity:0;filter:alpha(opacity=0)}@-webkit-keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);transform:translate3d(0,-100%,0)}100%{opacity:1;-webkit-transform:none;transform:none}}@keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0)}}</style><script>!function(){const n=function(){setTimeout(function(){const n=document.getElementById("loading-container");n.className="fadeout",setTimeout(function(){n.style.display="none"},2500)},1e3)};n()}()</script><body><div id="loading-container"><p class="loading-text">嘘~ 正在从服务器偷取页面 . . .</p><div class="loading-image"><div></div><div></div><div></div><div></div><div></div></div></div><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/medias/logo-3.png" class="logo-img" alt="LOGO"> <span class="logo-span mytitle">斯莫笔记</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home"></i><span>主</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags"></i><span>签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark"></i><span>类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive"></i><span>档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle"></i><span>吾</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments"></i><span>言</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/artitalk" class="waves-effect waves-light"><i class="fas fa-heartbeat"></i><span>语</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book"></i><span>友</span></a></li><li class="hide-on-med-and-down nav-item"><a href="https://play.zhangxiaocai.cn/" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fas fa fa-coffee"></i><span>聊</span></a></li><li class="hide-on-med-and-down nav-item"><a href="http://chat.zhangxiaocai.cn/" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fas fa fa-comment-alt"></i><span>问</span></a></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fas fa-list"></i> <span>秘</span> <i class="fas fa-chevron-down" aria-hidden="true"></i></a><ul class="sub-nav menus_item_child"><li><a href="/navigate"><i class="fas fa-location-arrow" style="margin-top:-20px"></i> <span>风域之门</span></a></li><li><a href="/box"><i class="fas fa-map-marker" style="margin-top:-20px"></i> <span>妖魔化镜</span></a></li><li><a href="https://hut.zhangxiaocai.cn" target="_blank" rel="noopener"><i class="fas fa-pen-alt" style="margin-top:-20px"></i> <span>阿蓝故事</span></a></li><li><a href="https://yun.zhangxiaocai.cn" target="_blank" rel="noopener"><i class="fas fa-cloud" style="margin-top:-20px"></i> <span>云上之城</span></a></li><li><a href="/color"><i class="fas fa-asterisk" style="margin-top:-20px"></i> <span>红飞翠舞</span></a></li><li><a href="https://status.zhangxiaocai.cn/" target="_blank" rel="noopener"><i class="fa fa-yin-yang" style="margin-top:-20px"></i> <span>沧海成渊</span></a></li></ul></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索"></i></a></li><li id="fullscreen_li" class="fullscreen"><a href="javascript:void(0);" class="modal-trigger waves-effect waves-light"><i id="fullscreen" class="fa fa-expand-arrows-alt" title="全屏"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/medias/logo-3.png" class="logo-img circle responsive-img"><div class="logo-name">斯莫笔记</div><div class="logo-desc">Small-Rose,张小菜苔,个人技术笔记,记录学习/开发问题</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言簿</a></li><li class="m-nav-item"><a href="/artitalk" class="waves-effect waves-light"><i class="fa-fw fas fa-heartbeat"></i> ArtiTalk</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li class="m-nav-item"><a href="https://play.zhangxiaocai.cn/" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fa-fw fas fa fa-coffee"></i> Fiora</a></li><li class="m-nav-item"><a href="http://chat.zhangxiaocai.cn/" target="_blank" rel="noopener" class="waves-effect waves-light"><i class="fa-fw fas fa fa-comment-alt"></i> Tyloo</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-list"></i> Secret <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/navigate" style="margin-left:75px"><i class="fa fas fa-location-arrow" style="position:absolute;left:50px"></i> <span>Navigation</span></a></li><li><a href="/box" style="margin-left:75px"><i class="fa fas fa-map-marker" style="position:absolute;left:50px"></i> <span>Siteboxing</span></a></li><li><a href="https://hut.zhangxiaocai.cn" target="_blank" rel="noopener" style="margin-left:75px"><i class="fa fas fa-pen-alt" style="position:absolute;left:50px"></i> <span>Writinging</span></a></li><li><a href="https://yun.zhangxiaocai.cn" target="_blank" rel="noopener" style="margin-left:75px"><i class="fa fas fa-cloud" style="position:absolute;left:50px"></i> <span>SmallCloud</span></a></li><li><a href="/color" style="margin-left:75px"><i class="fa fas fa-asterisk" style="position:absolute;left:50px"></i> <span>ColorWorld</span></a></li><li><a href="https://status.zhangxiaocai.cn/" target="_blank" rel="noopener" style="margin-left:75px"><i class="fa fa fa-yin-yang" style="position:absolute;left:50px"></i> <span>SiteStatus</span></a></li></ul></li></ul></div></div></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/medias/featureimages/23.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">Tomcat 执行流程</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:32px;bottom:155px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/Tomcat/"><span class="chip bg-color">Tomcat</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Tomcat/" class="post-category">Tomcat</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2020-10-25</div><div class="info-break-policy"><i class="fa fa-pencil"></i> 作者: Small-Rose / 张小菜</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp; 2020-10-25</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 5k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp; 19 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="Tomcat-执行流程"><a href="#Tomcat-执行流程" class="headerlink" title="Tomcat 执行流程"></a>Tomcat 执行流程</h2><h2 id="一、文件结构"><a href="#一、文件结构" class="headerlink" title="一、文件结构"></a>一、文件结构</h2><p>列举比较重要的</p><pre><code>----tomcat-x.x.x
  |
  |------bin/                  # 存放Tomcat 启动停止等相关的脚本文件
  |      |
  |      |------startup.bat    # Windows 环境启动脚本
  |      |
  |      |------startup.sh     # Linux 环境启动脚本
  |      |
  |      |------shutdown.bat   # Windows 环境停止脚本
  |      |
  |      |------shutdown.sh    # Linux 环境停止脚本
  |
  |------conf/                 # Tomcat 相关配置文件的目录
  |      |
  |      |------Catalina       # 存放每个虚拟机的Conext配置
  |      |
  |      |------catalina.properties   # Tomcat 的环境变量配置
  |      |
  |      |------catalina.policy       # Tomcat 运行安全策略配置
  |      |
  |      |------context.xml     # 定义web应用均需要加载的Context配置，若web应用指定了自己的context.xml，该文件会被覆盖
  |      |
  |      |------logging.properties    # Tomcat 的环境变量配置
  |      |
  |      |------server.xml            # Tomcat 服务的核心配置文件
  |      |
  |      |------tomcat-users.xml      # 设置 Tomcat m默认的用户和角色映射信息配置
  |      |
  |      |------web.xml               # Tomcat 中所有应用默认的部署描述文件，主要定义基础默认的servlet 和 MIME 映射
  |    
  |------lib/                 # Tomcat 服务器依赖的.jar文件的目录
  |
  |------logs/                # Tomcat 默认的日志文件的目录
  |
  |------temp/                # 存放Tomcat 启运行时的临时文件的目录
  |
  |------webapps/             # Tomcat 默认的web应用工程部署目录
  |
  |------work/                # Web 应用中的jsp文件编译生成的 .java 和 .calss 文件存放目录
  |      |
  |      |
  |
  |------其他文件</code></pre><h2 id="二、HTTP-协议"><a href="#二、HTTP-协议" class="headerlink" title="二、HTTP 协议"></a>二、HTTP 协议</h2><h3 id="1、基本概念"><a href="#1、基本概念" class="headerlink" title="1、基本概念"></a>1、基本概念</h3><p>HTTP协议是Hyper Text Transfer Protocol（超文本传输协议）的缩写,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议。</p><p>HTTP是一个基于TCP/IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。</p><p>HTTP是一个客户端终端（用户）和服务器端（网站）请求和应答的标准（TCP）。</p><p>主要特点：</p><ul><li>无连接 ： 默认每次连接只处理一个轻轻。收到响应就会断开连接。</li><li>无状态 ： 指的是HTTP协议对事务处理没有记忆能力。</li><li>媒体独立 ： 任何类型的数据都可以使用HTTP发送，使用MIME-type指定内容类型即可。</li></ul><h3 id="2、HTTP-消息结构"><a href="#2、HTTP-消息结构" class="headerlink" title="2、HTTP 消息结构"></a>2、HTTP 消息结构</h3><p>HTTP是基于客户端/服务端（C/S）的架构模型。</p><p>客户端发送一个HTTP请求到服务器的请求消息包括以下格式：请求行（request line）、请求头部（header）、空行和请求数据四个部分组成。</p><p>客户端返回一个HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。</p><p>下面是百度找的一张轻轻格式图：</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/http-request-geshi.jpg" alt="HTTP Request"></p><p>响应的格式基本一致，也找一张书里的图：</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/http-response-geshi.jpg" alt="HTTP Response"></p><p>请求方法：</p><p>HTTP1.0 定义了三种请求方法： GET, POST 和 HEAD方法。</p><p>HTTP1.1 新增了六种请求方法：OPTIONS、PUT、PATCH、DELETE、TRACE 和 CONNECT 方法。</p><h3 id="3、HTTP-工作过程："><a href="#3、HTTP-工作过程：" class="headerlink" title="3、HTTP 工作过程："></a>3、HTTP 工作过程：</h3><p><img src="/medias/loading-animated.gif" data-original="/images/http/http-work.png" alt="HTTP 工作原理"></p><p>（1）浏览器URL输入之后回车，或者点击某个超链接，浏览器开始获事件开始执行。</p><p>（2）访问域名会被DNS服务器解析成对应IP地址，默认端口是80。有了IP和端口，浏览器像服务端端发出TCP请求</p><p>（3）服务器程序接受浏览器连接请求，并行经过TCP三次握手建立连接。</p><p>（4）浏览器将请求数据打包成一个 <code>HTTP协议</code> 格式的数据包。</p><p>（5）浏览器将该该数据包发送到网络，经过网络传输到达（之前TCP握手之后建立的连接）服务端。</p><p>（6）服务端程序拿到这个数据包后，也使用 <code>HTTP协议</code> 格式解析数据包，获取客户端的资源请求。</p><p>（7）解析请求之后，根据相关调用（静态文件或动态程序）进行处理，获得返回结果。</p><p>（8）服务器将结果（HTML文件或其他格式文件）按照 <code>HTTP协议</code>格式打包。</p><p>（9）服务器将打包的结果发生到网络，经过传输之后，返回给浏览器。</p><p>（10）浏览器得到响应的数据包之后，使用 <code>HTTP协议</code>格式解析数据包，做出相关事件动作。（如HTML则进行文件解析展示，其他格式可能是下载）</p><h2 id="三、Tomcat-架构"><a href="#三、Tomcat-架构" class="headerlink" title="三、Tomcat 架构"></a>三、Tomcat 架构</h2><h3 id="1、HTTP请求处理"><a href="#1、HTTP请求处理" class="headerlink" title="1、HTTP请求处理"></a>1、HTTP请求处理</h3><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-work-01.png" alt="HTTP 配合Servlet 工作"></p><p>HTTP 服务把请求交给 <code>Servlet容器</code> 来处理，<code>Servlet容器</code>，再通过Servlet接口调用业务类。使用 <code>Servlet容器</code> 和 <code>Servlet接口</code> 实现HTTP服务和业务<mark>解耦</mark>。 <code>Servlet容器</code> 和 <code>Servlet接口</code> 相关使用的规范称为<code>Servlet规范</code> 。</p><p>Tomcat 按照 <code>Servlet规范</code> 的要求实现了 <code>Servlet容器</code>，同时他们也具有HTTP服务的功能。</p><h3 id="2、Servlet容器工作流程"><a href="#2、Servlet容器工作流程" class="headerlink" title="2、Servlet容器工作流程"></a>2、Servlet容器工作流程</h3><p><img src="/medias/loading-animated.gif" data-original="/images/http/http-servlet-work.png" alt="Servlet 工作流程"></p><p>主要工作流程：</p><p>（1）HTTP服务器接收到客户端请求后，会将客户端请求信息封装到一个 <code>ServletRequest</code> 对象中。</p><p>（2）封装完成后，调用<code>Servlet容器</code> 的 <code>service()</code> 方法。</p><p>（3）<code>Servlet容器</code> 获取到请求信息后，根据请求的URL 和 Servlet 的映射关系，找到对应的 Servlet （如果Servlet没有被加载，则使用反射创建对应的Servlet实例，并调用Servlet的 <code>init()</code>方法来完成初始化）。</p><p>（4）接着，调用对应的 Servlet 的 <code>service()</code> 方法来处理请求。</p><p>（5）请求处理完成完成后，将结果封装成 <code>ServletResponse</code> 对象返回给HTTP服务器。</p><p>（6）HTTP服务器再打包HTTP格式，响应给客户端。</p><h3 id="3、Tomcat-架构"><a href="#3、Tomcat-架构" class="headerlink" title="3、Tomcat 架构"></a>3、Tomcat 架构</h3><p>Tomcat 架构 基于上述工作流程。</p><p>Tomcat的2个核心功能：</p><p>（1）处理Socket连接，将请求与Request对象转换，将Response对象转换成响应。</p><p>（2）加载和管理Servlet，记忆具体处理Request请求。</p><p>因此Tomcat设计两个核心组件，连接器（<code>Connector</code>）和容器（<code>Container</code>）来分别完整这两个功能。<code>Connector</code>连接器负责对外交流，<code>Container</code> 负责对收到的请求做内部处理。</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-work-02.png" alt="Servlet 架构"></p><p>Tomcat 中有多个Services。</p><p>处理流程：</p><p>（1）客户端发起请求，tomcat的<code>Connector</code>连接器会接收Socket请求，并且将接收到的Socket 请求转换成<code>ServletRequest</code>对象。</p><p>（2）接着，将<code>ServletRequest</code>对象转交给<code>Container</code>容器进行处理。</p><p>（3）<code>Container</code>容器接收到<code>ServletRequest</code> 之后就去定位对应的Servlet，找到可以执行的Servlet，如果对应的Servlet没有加载，就先加载Servlet，找到之后定位对应的逻辑方法进行处理。</p><p>（4）对应的Servlet处理完成之后将处理的结果封装成<code>ServletResponse</code>对象响应给<code>Connector</code>连接器。</p><p>（5）<code>Connector</code>连接器接收到<code>ServletResponse</code>对象之后解析<code>ServletResponse</code>对象，给客户端的Socket连接最终响应。</p><h3 id="4、链接器-Coyote"><a href="#4、链接器-Coyote" class="headerlink" title="4、链接器 Coyote"></a>4、链接器 Coyote</h3><h4 id="4-1-Coyote-架构"><a href="#4-1-Coyote-架构" class="headerlink" title="4.1 Coyote 架构"></a>4.1 Coyote 架构</h4><p>Coyote 是tomcat的链接器框架的名字，是tomcat服务器提供的供客户端访问的外部接口。客户端通过 Coyote 与服务器建立连接、发送请求并接收响应。</p><p>Coyote 封装了网络通信 Socket 请求和响应的处理，为 Catalina 容器提供了统一的接口，使 Catalina 容器与具体的请求协议以及IO操作完全解耦。</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-coyote-work-01.png" alt="Coyote 与 Catalina 交互"></p><p>Coyote 将Socket输入转换封装成Request对象，交由Catalina 容器进行处理，处理请求完成后，Catalina 通过Coyote 返回的Response对象将结果输出流返回。</p><p>Coyote 作为独立模块，只负责具体协议和IO操作，与 Servlet 规范实现没有直接关系，因此 Request 和 Response 对象也并未实现 Servlet 规范对应的接口，而是在 Catalina 容器中将他们进一步封装为 ServletRequest 和ServletResponse 。</p><h4 id="4-2-IO模型与协议"><a href="#4-2-IO模型与协议" class="headerlink" title="4.2 IO模型与协议"></a>4.2 IO模型与协议</h4><p>tomcat 支持的IO：</p><table><thead><tr><th>版本</th><th>IO模型</th><th>描述</th></tr></thead><tbody><tr><td>&lt; 8.5</td><td>BIO</td><td>阻塞I/O，8.0之前默认的方式。</td></tr><tr><td>&gt;= 8.5</td><td>NIO</td><td>非阻塞I/O，Java NIO类库实现</td></tr><tr><td>&gt;= 8.5</td><td>NIO2/AIO</td><td>异步非阻塞I/O，采用最新的NIO类库实现</td></tr><tr><td>&gt;= 8.5</td><td>APR</td><td>采用Apache可移植运行库实现，是C/C++编写的本地库。如果选择该方案，需要单独安装APR库。</td></tr></tbody></table><p>tomcat 支持的应用层协议：</p><table><thead><tr><th>应用层协议</th><th>描述</th></tr></thead><tbody><tr><td>HTTP/1.1</td><td>这是大部分web应用采用的访问协议</td></tr><tr><td>AJP</td><td>用于和web服务器基础（如Apache），以实现对静态资源的优化以及集群部署，当前支持AJP/1.3</td></tr><tr><td>HTTP/2</td><td>HTTP 2.0 大幅提升web性能，下一代HTTP协议，8.5及以后版本支持</td></tr></tbody></table><p>协议分层：</p><pre class="language-txt"><code class="language-txt">--------------------------------------
应用层       HTTP     AJP     HTTP2
               processor
--------------------------------------
传输层       NIO     NIO2     APR
                Endpoint
--------------------------------------</code></pre><p>Tomcat 本身支持多种IO模型和应用层协议，一个容器可以对接多个链接器。单独的链接器或单独的容器都不能对外提供服务，二者组装到一起才能工作，这个组装之后的整体成为<strong>Service组件</strong>。</p><p>Service组件本身没有做什么特别的事情，只是将链接器和容器进行了包装，将二者组装到了一起。</p><p>Tomcat 内可能有多个Service，配置多个Service 可以实现通过不同端口号来访问同一个机器上部署的不同应用。</p><h4 id="4-3-链接器组件"><a href="#4-3-链接器组件" class="headerlink" title="4.3 链接器组件"></a>4.3 链接器组件</h4><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-coyote-work-02.png" alt="Tomcat 链接器组件"></p><p>链接器各个组件作用：</p><p><strong>EndPont 组件</strong></p><p>（1）EndPoint ：Coyote 通信端点，通信监听的接口，是具体Socket接收和发生处理器，是对传输层的抽象，因此 EndPoint 用来实现TCP/IP协议的。</p><p>（2）Tomcat 中并没有 EndPoint 接口，而是有一个AbstractEndPoint，里面定义了两个内部类，Acceptor 和 SocketProcessor 。Acceptor 用于监听Socket请求，SocketProcessor 用于处理接收到的Socket的请求，塔实现Runnable 接口，在Run方法里面调用协议处理组件Processor 进行处理。为了提高处理能力，SocketProcessor 被提交到线程池来执行。而这个线程池叫做执行器Executor。</p><p><strong>Processor 组件</strong></p><p>Processor ：coyote 协议处理接口，如果说EndPoint 是用来实现TCP/IP协议的，那么Processor 用来实现HTTP协议，Processor 接收来自 EndPoint 的Socket请求，读取字节流解析成 Tomcat的 Request 和 Response 对象，并通过Adapter将其交到容器处理，Processor 是对应用层协议的抽象。</p><p><strong>ProtocolHandler 组件</strong></p><p>ProtocolHandler：Coyote 协议接口，通过<code>EndPoint</code> 和 <code>Processor</code> ，实现针对具体协议的处理能力，Tomcat 按照协议和I/O提供6个实现类：<code>AjpNioProtocol</code>、<code>AjpAprProtocol</code>、<code>AjpNio2Protocol</code>、<code>Http11NioProtocol</code>、<code>Http11Nio2Protocol</code>、<code>Http11AprProtocol</code>。</p><p>在配置<code>tomcat/conf/server.xml</code>时，至少要指定具体的<code>ProtocolHandler</code>，也可以指定协议名称如：<code>HTTP/1.1</code>，如果按照了APR，那么将使用<code>HttpAprProtocol</code>，否则使用<code>Http11NioProtocol</code></p><p><strong>Adapter 组件</strong></p><p>由于协议不同，客户端发过来的请求信息也不尽相同，Tomcat 定义了自己的Request 对来存在这些请求信息。</p><p>ProtocolHandler接口负责解析请求并生成Tomcat的Request类，但是这个Request对象不是标准的ServletRequest对象，即不能用Tomcat的Request作为参数来调用容器。于是有了这个 CoyoteAdapter适配器，适配器模式的经典运行。</p><p>链接器Coyote 调用<code>CoyoteAdapter</code>的Service方法，传入的是Tomcat的Request对象，<code>CoyoteAdapter</code>负责将</p><p>Tomcat的Request对象转换成ServletRequest，再调用容器的Service方法。</p><h3 id="5、容器-Catalina"><a href="#5、容器-Catalina" class="headerlink" title="5、容器 Catalina"></a>5、容器 Catalina</h3><p>Tomcat 是由一系列的可配置组件构成的web容器，Tomcat的Servlet容器就叫做 <code>Catalina</code>。</p><p><code>Catalina</code> 是Servlet 容器的实现，包含前面学习的Coyote组件等。它通过松耦合的方法集成Coyote，以完成按照请求协议进行数据读写。同时，还包括启动入口，shell程序等。</p><h4 id="5-1-Catalina-地位"><a href="#5-1-Catalina-地位" class="headerlink" title="5.1 Catalina 地位"></a>5.1 Catalina 地位</h4><p>Tomcat 组件分层结构：</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-catalina-diwei.png" alt=""></p><p>Tomcat 的本质是Servlet 容器，因此 Catalina 是Tomcat的核心，其他模块都是为Catalina 模块提供支撑。如：通过Coyote 模块提供连接通信，Jasper模块提供JSP引擎，Naming 提供JNDI服务，Juli提供日志服务。</p><h4 id="5-2-Catalina-结构"><a href="#5-2-Catalina-结构" class="headerlink" title="5.2 Catalina 结构"></a>5.2 Catalina 结构</h4><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-catalina-jiegou.jpg" alt="Catalina 结构"></p><p>Catalina 负责管理Server，而Server表示整个服务器，Server下面有多个服务Service，每个服务都包含着多个链接器组件Connector（Coyote实现）和一个容器组件 Container。</p><p>在Tomcat 启动的时候，会初始化一个Catalina的实例。</p><p>书中的结构图：</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-catalina-jiegou-02.png" alt="Catalina 结构"></p><p>Catalina 各个组件的职责：</p><table><thead><tr><th>组件</th><th>职责</th></tr></thead><tbody><tr><td>Catalina</td><td>负责解析Tomcat 配置文件，创建服务器Server组件，并根据命令来进行管理。</td></tr><tr><td>Server</td><td>Server服务器表示整个Catalina Servlet容器以及其他组件，负责组装并启动Servlet引擎，Tomcat连接器。Server通过实现Lifecycle接口，提供一个优雅的启动和关系系统的方式。</td></tr><tr><td>Service</td><td>服务就是Server内部的组件，一个Server可以包含多个Service。它将若干个Connector组件绑定到一个Container（Engine）上</td></tr><tr><td>Connector</td><td>连接器，处理与客户端通信，负责接收客户端请求，然后传给相关容器处理，最后向客户端返回响应结果。</td></tr><tr><td>Container</td><td>容器，负责处理用户的Servlet请求，并返回对应给web用户的模块</td></tr></tbody></table><h4 id="5-3-Container-结构"><a href="#5-3-Container-结构" class="headerlink" title="5.3 Container 结构"></a>5.3 Container 结构</h4><p>在 Container 中，tomcat 设计了4种容器分别是Engine、Host、Context和Wrapper。</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-container-jiegou-01.png" alt="Container 结构"></p><p>Container 各个组件的职责：</p><table><thead><tr><th>组件</th><th>职责</th></tr></thead><tbody><tr><td>Engine</td><td>表示整个Catalina的Servlet引擎，用来管理多个虚拟站点，一个Service最多只能有一个Engine，但是一个引擎可以包含多个Host。</td></tr><tr><td>Host</td><td>Host代表一个虚拟主机（站点），可以给tomcat配置多个虚拟主机地址，而一个虚拟主机下可以包含多个Context。</td></tr><tr><td>Context</td><td>表示一个web应用程序，一个web应用可以包含多个Wrapper。</td></tr><tr><td>Wrapper</td><td>表示一个Servlet，Wrapper 作为容器的最底层，不能包含子容器。</td></tr></tbody></table><p>这些关系如果不去看源码，也可以在server.xml中体现，这是一个删除了大部分注释的默认配置：</p><pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8005<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.startup.VersionLoggerListener<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">SSLEngine</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>on<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.core.AprLifecycleListener<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token comment" spellcheck="true">&lt;!-- Prevent memory leaks due to use of particular java/javax APIs--></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.core.JreMemoryLeakPreventionListener<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.mbeans.GlobalResourcesLifecycleListener<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.core.ThreadLocalLeakPreventionListener<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GlobalNamingResources</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Resource</span> <span class="token attr-name">auth</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Container<span class="token punctuation">"</span></span> <span class="token attr-name">description</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User database that can be updated and saved<span class="token punctuation">"</span></span> <span class="token attr-name">factory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.users.MemoryUserDatabaseFactory<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserDatabase<span class="token punctuation">"</span></span> <span class="token attr-name">pathname</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>conf/tomcat-users.xml<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.UserDatabase<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GlobalNamingResources</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8080<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8009<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AJP/1.3<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span> <span class="token attr-name">defaultHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Realm</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.realm.LockOutRealm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!-- This Realm uses the UserDatabase configured in the global JNDI
             resources under the key "UserDatabase".  Any edits
             that are performed against this UserDatabase are immediately
             available for use by the Realm.  --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Realm</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.realm.UserDatabaseRealm<span class="token punctuation">"</span></span> <span class="token attr-name">resourceName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserDatabase<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Realm</span><span class="token punctuation">></span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span> <span class="token attr-name">appBase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>webapps<span class="token punctuation">"</span></span> <span class="token attr-name">autoDeploy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token attr-name">unpackWARs</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.valves.AccessLogValve<span class="token punctuation">"</span></span> <span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>%h %l %u %t &amp;quot;%r&amp;quot; %s %b<span class="token punctuation">"</span></span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost_access_log<span class="token punctuation">"</span></span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.txt<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span> <span class="token attr-name">docBase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>z-blog-BS<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/zblog<span class="token punctuation">"</span></span> <span class="token attr-name">reloadable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.eclipse.jst.jee.server:z-blog-BS<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Engine</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">></span></span></code></pre><h3 id="6、Tomcat-启动流程"><a href="#6、Tomcat-启动流程" class="headerlink" title="6、Tomcat 启动流程"></a>6、Tomcat 启动流程</h3><h4 id="6-1、主要流程"><a href="#6-1、主要流程" class="headerlink" title="6.1、主要流程"></a>6.1、主要流程</h4><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-start-up-process.jpg" alt="Tomcat 启动流程图"></p><p>主要步骤：</p><p>（1）Tomcat 启动执行启动脚本<code>startup.bat</code>或<code>startup.sh</code>，在启动脚本中调用<code>catalina.bat</code> （catalina.sh）</p><p>（2）在<code>catalina.bat</code> 脚本中，调用Tomcat的 Bootstrap 类的main方法。</p><p>（3）Bootstrap 类的main方法调用 init 方法，来创建 Catalina 并 初始化类加载器。</p><p>（4）init 方法执行之后，调用 load 方法，load 方法中调用 Catalina 的 load 方法。</p><p>（5）在 Catalina 的 load 方法中，进行一些初始化操作，构造Digester 对象解析XML 。</p><p>（6）然后解析server.xml之后，就可以根据配置一层一层的将组件进行初始化。</p><p>（7）初始化然后之后，调用start 方法，整体过程基本同上，一层一层的进行 start 方法调用，启动组件。</p><h4 id="6-2、主要接口"><a href="#6-2、主要接口" class="headerlink" title="6.2、主要接口"></a>6.2、主要接口</h4><p>（1）Lifecycle 接口</p><p>抽象所有组件的初始化、启动、停止等声明周期方法，进行生命周期管理。</p><p>Server、Service、Container、Executor、Connector 组件都实现了改接口，也有了Lifecycle 接口核心方法：</p><ul><li>init() ：初始化组件</li><li>start() ：启动组件</li><li>stop() ：停止组件</li><li>destroy() ：销毁组件</li></ul><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-lifecycle-01.png" alt=""></p><p>（2）组件接口的默认实现</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-interface-impl.png" alt=""></p><p>其中，EndPoint 组件，没有对应的 EndPoint 接口，而是使用AbstractEndPoint抽象类，该抽象类下有三个实现类：NioEndPoint、Nio2EndPoint、AprEndPoint。这三个实现类，对应着Coyote链接器支持的三种IO模型：NIO、NIO2（AIO）、APR。（Tomcat 8.5版默认采用是NioEndPoint）</p><p>ProtocolHandler ：coyote 协议接口，通过封装 EndPoint 和 Processor ，实现对具体协议的处理功能。Tomcat 安装协议和IO提供了6个实现类：</p><p>AJP协议：</p><ul><li>AjpNioProtocol ：采用NIO 的IO模型。</li><li>AjpNio2Protocol：采用NIO的IO模型。</li><li>AjpAprProtocol：采用APR的IO模型，依赖APR库。</li></ul><p>HTTP协议：</p><ul><li>Http11NioProtocol ：采用NIO 的IO模型。默认使用的协议，如果服务器没有安装APR。</li><li>Http11Nio2Protocol ：采用NIO2 的IO模型。</li><li>Http11AprProtocol：采用APR的IO模型，需要依赖APR库。</li></ul><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-interface-impl-02.png" alt=""></p><p>（3）源码main 方法入口：</p><pre class="language-java"><code class="language-java"></code></pre><p>（4）小结</p><p>从起点流程图就可以看出Tomcat的启动过程很标准化，统一安装Lifecycle 的定义进行启动。首先调用 <code>init()</code> 方法进行组件的逐级初始化操作，然后再调用 <code>start()</code> 方法进行启动。</p><p>每一层级组件除了完成自身的处理，还要负责调用子组件相应的生命周期管理方法，组件与组件之间是松耦合，因为可以使用配置文件进行修改和替换。</p><h3 id="7、tomcat-处理流程"><a href="#7、tomcat-处理流程" class="headerlink" title="7、tomcat 处理流程"></a>7、tomcat 处理流程</h3><h4 id="7-1-请求流程"><a href="#7-1-请求流程" class="headerlink" title="7.1 请求流程"></a>7.1 请求流程</h4><p>Tomcat 有将组建一层一层的封装，怎么确定每个请求应该是由哪个Wrapper容器里的Servlet来处理呢？</p><p>原因是因为Tomcat 用Mapper组件来完成这个任务。</p><p>Mapper 组件的功能就是将用户请求的URL定位到一个Servlet，它的工作原理是：Mapper组件里保存了Web应用的配置信息，其实就是容器组件与访问路径的映射关系。比如<code>Host</code>容器里配置的域名、<code>Context</code>容器里的Web 应用路径，以及Wrapper容器里Servlet映射的路径，这些配置信息好比装在一个多层级嵌套的Map里面。</p><p>当一个请求过来，Mapper组件通过解析请求URL里的域名和路径，在到自己保存的Map里面查找，就能定位到一个Servlet，并且一个请求URL最后只会定位到一个Wrapper容器，也就是定位唯一的一个Servlet。</p><p>如请求路径为：<a href="http://zhangxiaocai.cn/webdemo/findUsers" target="_blank" rel="noopener">http://zhangxiaocai.cn/webdemo/findUsers</a></p><pre class="language-txt"><code class="language-txt">+--------------------------------------------------------------------------------+
                                                                     /findUsers
                                                       /webdemo     +-- Wrapper  
                              www.zhangxiaocai.cn   +- Context -+---+
                                          +------+  +               +-- Wrapper  
                                        +-+ Host +--+
                                        + +------+  +                                          
                                        +           +   /grabpic    +-- Wrapper 
                                        +           +- Context -+---+
       +-----------+    +-----------+   +                           +-- Wrapper 
       +           +    +  Service  +   +
URL -->+ Connector +--> +           +---+
       +           +    +  Engine   +   +
       +-----------+    +-----------+   +
                                        +              /blog        +-- Wrapper 
                                        +           +---Context--+--+
                                        + +------+  +               +-- Wrapper 
                                        +-+ Host +--+
                                          +------+  +
                              hut.zhangxiaocai.cn   +  /bbs         +-- Wrapper 
                                                    +- Context -+---+
                                                                    +-- Wrapper 

+---------------------------------------------------------------------------------+ </code></pre><p>Tomcat 请求处理流程图：</p><p>![](/images/http/</p><p>主要步骤：</p><p>（1）<code>Connector</code>连接器组件中<code>EndPoint</code>中的<code>acceptor</code>监听客户端套接字连接并建立Socket连接。</p><p>（2）将连接交给线程池<code>Executor</code>处理，开始执行请求响应任务。</p><p>（3）<code>Processor</code>组件读取消息包围，解析请求行、请求头、请求体，封装成<code>Request</code>对象。</p><p>（4）<code>Mapper</code>组件根据请求行的URL值和请求头的Host值匹配由哪个<code>Host容器</code>、<code>Context容器</code>、<code>Wrapper容器</code>处理请求。</p><p>（5）CoyoteAdaptor组件复制将<code>Connector</code>组件和<code>Engine</code>容器关联起来，把生成<code>Request</code>对象和响应对象<code>Response</code>传递到<code>Engine</code>容器中，调用<code>Pipeline</code>。</p><p>（6）<code>Engine</code>容器的管道开始处理，管道中包含若干个<code>Valve</code>、每个<code>Valve</code>复制部分处理逻辑。执行完<code>Valve</code>后会执行基础的<code>Valve</code>，叫<code>StandardEngineValve</code>，负责调用Host容器的Pipeline。</p><p>（7）<code>Host</code>容器的管道开始处理，流程与Engine类似，最后执行<code>Context</code> 的Pipeline。</p><p>（8）<code>Context</code>容器的管道开始处理，流程与Engine类似，最后执行<code>Wrapper容器</code>的Pipeline。</p><p>（9）<code>Context</code> 容器的管道开始处理，流程与Engine类似，最后执行<code>Wrapper容器</code>对应的Servlet对象的处理方法。</p><p><img src="/medias/loading-animated.gif" data-original="/images/http/tomcat-request-handle-process.png" alt="Tomcat 请求处理流程"></p><p>Tomcat 中的各个组件各自处理各自的事情，组件之间松耦合，确保整体架构的可伸缩性和扩展性，在组件内部如何增强组件灵活性和扩展性？在Tomcat的每个Container 中采用责任链模式来完成具体的请求处理。</p><p>Tomcat中定义<code>Pipeline</code>和<code>Valve</code> 两个接口，<code>Pipeline</code>用于构建责任链，<code>Valve</code> 代表责任链上的每个处理器。<code>Pipeline</code> 中维护了一个基础的<code>Valve</code>，它始终位于<code>Pipeline</code>的末端，总是最后执行，封装了具体的请求处理和输出响应的过程。当然，也可以调用<code>addValve()</code> 方法，为<code>Pipeline</code>添加其他的<code>Valve</code>，后添加的<code>Valve</code>位于基础的<code>Valve</code>之前，并且按照添加的顺序执行。<code>Pipeline</code>通过获得首个<code>Valve</code>启用整个链条的执行。</p><p>四、其他</p><p>Tomcat 相关的不少，配置部分单独。</p><p>学习参考资料：<br>（1）Tomcat 源码分析教程<a href="https://www.bilibili.com/video/BV1dJ411N7Um?p=22" target="_blank" rel="noopener">B站视频原链接</a><br>（2）《Tomcat 架构解析》<br>（3）网络资料整理。</p><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css"></div><br><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">Small-Rose / 张小菜</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://www.zhangxiaocai.cn/posts/7aaae6eb.html">https://www.zhangxiaocai.cn/posts/7aaae6eb.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">Small-Rose / 张小菜</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/Tomcat/"><span class="chip bg-color">Tomcat</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22AB38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019FE8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(/medias/202007bg.webp) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments .vbtn{background-color:#0bb7fbd6;color:#fff}.v[data-class="v"] .vwrap .vheader .vinput{width:32%;border-bottom:1px dashed #dedede}.v[data-class=v] .vwrap .vemojis i{font-style:normal;padding-top:7px;width:36px;cursor:pointer;text-align:center;display:inline-block;vertical-align:middle;padding-right:3px;padding-left:3px}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/valine/av-min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/valine/Valine.min.js"></script><script>let metaPlaceholder = {"nick":"昵称/QQ号(必填)","mail":"邮箱(必填)","link":"网址(https://)"}

    new Valine({
        el: '#vcomments',
        mode: 'xCss',
        appId: 'iTxfqh5e9IaRfiiVOTbIWoKa-9Nh9j0Va',
        appKey: 'C5s5xGFErD1Et90bvbPvNDsB',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'monsterid',
        pageSize: '10',
        lang: 'zh-CN',
        placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊！什么？想走？打劫！赶紧提交出你的评论，全部要写好~ ',
        meta: ["nick", "mail", "link"],
        recordIP: 'true' === 'true',
        enableQQ: 'monsterid',
        requiredFields: ["68c4c9e1b9a3d34317dc6faefe2ea00e"],
        master: ["68c4c9e1b9a3d34317dc6faefe2ea00e"],
        friends: ["7a455d704b60807098d18cc8c2470da2", "8acd51671b7e0e1dc68cc76d4d987813", "c08508165c8eba9a77f87285c046d09e", "901345d4c91ddfd8db0f975bbceaf0c8", "1512958e18378c98b498d5ef8e3e763f", "db6069f3bda06d2a9157c4a622ce4648", "fc2c9b067f65c9e2d7057ba797f7cfca", "256a83cdeb9a494df572ef260e98c9bf", "9f38a40d977e6e8a6a555fef3849f23a", "95dbe659464f10506676f48b11962ef7", "93c72e67b6b84508525f5566b865db2d"],
        tagMeta: ["博主", "小伙伴", "访客"],
        metaPlaceholder: metaPlaceholder,

    });

    document.body.addEventListener('click', function(e) {
    if (e.target.classList.contains('vsubmit')) {
        const email = document.querySelector('input[type=email]');
        const nick = document.querySelector('input[name=nick]');
        const reg = /^[A-Za-z0-9_-\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
        if (!email.value || !nick.value || !reg.test(email.value)) {
            const str = `<div class="valert txt-center"><div class="vtext">请填写正确的昵称和邮箱！</div></div>`;
            const vmark = document.querySelector('.vmark');
            vmark.innerHTML = str;
            vmark.style.display = 'block';

            e.stopPropagation();

            setTimeout(function() {
                vmark.style.display = 'none';
                vmark.innerHTML = '';
            }, 2500);
        }
    }
    }, true);</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/78ec1f93.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/medias/featureimages/0.jpg" class="responsive-img" alt="SpringBoot Cache"> <span class="card-title">SpringBoot Cache</span></div></a><div class="card-content article-content"><div class="summary block-with-text">本文整理SpringBoot Cache学习。</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-10-25 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/SpringBoot/" class="post-category">SpringBoot</a></span></div></div><div class="card-action article-tags"><a href="/tags/Cache/"><span class="chip bg-color">Cache</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/193c9d75.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/medias/featureimages/34.jpg" class="responsive-img" alt="Memcache 快速上手"> <span class="card-title">Memcache 快速上手</span></div></a><div class="card-content article-content"><div class="summary block-with-text">本文记录Memcache相关学习和整理。</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-10-24 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Memcache/" class="post-category">Memcache</a></span></div></div><div class="card-action article-tags"><a href="/tags/Memcache/"><span class="chip bg-color">Memcache</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){if("undefined"!=typeof window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("120"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName?o.innerHTML="<pre>"+o.innerHTML+"</pre>":o.innerHTML="<pre>"+o.innerHTML+"</pre>";var i=document.location.href;o.innerHTML+='<br />来源: 斯莫笔记<br />文章作者: Small Rose / 张小菜苔<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)}}})</script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{display:none;font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{display:none;font-size:15px;color:#42b983}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="netease" type="playlist" id="2056253259" fixed="true" autoplay theme="#42b983" loop order="random" preload="auto" volume="0.7" list-folded="true"></meting-js></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2020</span> <a href="/about" target="_blank">Small Rose / 张小菜苔</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a> |&nbsp;Comments&nbsp;<a href="https://valine.zhangxiaocia.cn" target="_blank">Valine</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">398.7k</span>&nbsp;字 <span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><span id="sitetime">载入运行时间...</span><script>function siteTime(){var e=1e3,t=60*e,n=60*t,o=24*n,l=365*o,r=new Date,a="2020",i="5",d="1",m="0",M="0",g="0",s=r.getFullYear(),u=r.getMonth()+1,T=r.getDate(),c=r.getHours(),f=r.getMinutes(),h=r.getSeconds(),y=Date.UTC(a,i,d,m,M,g),H=Date.UTC(s,u,T,c,f,h),I=H-y,B=Math.floor(I/l),D=Math.floor(I/o-365*B),E=Math.floor((I-(365*B+D)*o)/n),L=Math.floor((I-(365*B+D)*o-E*n)/t),v=Math.floor((I-(365*B+D)*o-E*n-L*t)/e);a==s?(document.getElementById("year").innerHTML=s,document.getElementById("sitetime").innerHTML="本站已 <del>安全</del> 苟全运行 "+D+" 天 "+E+" 小时 "+L+" 分钟 "+v+" 秒"):(document.getElementById("year").innerHTML=a+" - "+s,document.getElementById("sitetime").innerHTML="本站已 <del>安全</del> 苟全运行 "+B+" 年 "+D+" 天 "+E+" 小时 "+L+" 分钟 "+v+" 秒")}setInterval(siteTime,1e3)</script><br><span id="icp"><img src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/medias/icp.png" style="vertical-align:text-bottom"> <a href="http://beian.miit.gov.cn/" target="_blank">鄂ICP备19015637号-1</a></span><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/small-rose" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:small-rose@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=970175021" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 970175021" data-position="top" data-delay="50"><i class="fab fa-qq"></i> </a><a href="https://stackoverflow.com/users/5063539/small-rose" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://stackoverflow.com/users/5063539/small-rose" data-position="top" data-delay="50"><i class="fab fa-zhihu1">知</i> </a><a href="https://yun.zhangxiaocia.cn" class="tooltipped" target="_blank" data-tooltip="个人云盘" data-position="top" data-delay="50"><i class="fas fa-cloud"></i></a></div></div></footer><div class="progress-bar"></div><script type="text/javascript">window.$crisp=[],window.CRISP_WEBSITE_ID="bf3c468c-2fd7-4dcc-866d-3b008127fff0",function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)}()</script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/js/search.js"></script><script type="text/javascript">$(function(){searchFunc("https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/materialize/materialize.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/masonry/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/aos/aos.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/scrollprogress/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/js/matery.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?90b288cd6d944c8f4f8f0258e60bf981";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/others/clicklove.js" async></script><script async src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/others/busuanzi.pure.mini.js"></script><script type="text/javascript" size="150" alpha="0.6" zindex="-1" src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/background/ribbon.min.js" async></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/libs/instantpage/instantpage.js" type="module"></script><script src="/js/sakura.js" type="module"></script><script src="https://cdn.jsdelivr.net/gh/small-rose/small-rose.github.io/js/fullscreen.js" type="module"></script><script>window.imageLazyLoadSetting={isSPA:!1,processImages:null}</script><script>window.addEventListener("load",function(){var a=/\.(gif|jpg|jpeg|tiff|png)$/i,e=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(t){var r=t.parentNode;"A"===r.tagName&&(r.href.match(a)||r.href.match(e))&&(r.href=t.dataset.original)})})</script><script>!function(t){function e(){n&&(i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var e,o,a=0;a<i.length;a++)e=i[a],0<=(o=e.getBoundingClientRect()).bottom&&0<=o.left&&o.top<=(t.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,o,r=i[a];t=r,e=function(){i=i.filter(function(t){return r!==t})},n=new Image,o=t.getAttribute("data-original"),n.onload=function(){t.src=o,e&&e()},n.src=o}()}t.imageLazyLoadSetting.processImages=e;var n=t.imageLazyLoadSetting.isSPA,i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));e(),t.addEventListener("scroll",function(){var n,i;n=e,i=t,clearTimeout(n.tId),n.tId=setTimeout(function(){n.call(i)},500)})}(this)</script><script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = 'https://cdn.webpushr.com/app.min.js';fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BJrux_BJKMKcoDBNWov5dsd0zhl3p0eF00OUzgogE5bQRheUA7eytp5rcZXYHdodyiVfbOmMlAkf140zUrAPfv4');</script></body></html><!-- rebuild by neat -->